<html>
<head>
  <title>7.5--删除用户</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1495"/>
<h1>7.5--删除用户</h1>

<div>
<span><div><div>删除用户 </div><div><br/></div><div>接下来我们完成删除用户的功能, 删除用户的操作只能由管理员来操作, 因此下面需要为用户表加上管理员字段, 以便来判断用户是否为管理员, 然后将管理员身份授权给某个用户, 让其可以删除用户, 最后我们还要在用户列表上加上删除按钮, 只有当管理员账号登录时才能看到删除按钮并对用户进行删除</div><div><br/></div><div>管理员</div><div><br/></div><div>我们需要生成一个迁移文件来为用户表新增管理员字段, 在生成迁移文件时, 带上 --tanle 选项可以为制定数据表生成迁移文件. 现在让我们运行以下命令来为用户表新增管理员字段</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan make:migration add_is_admin_to_users_table --table=users</div></div><div><br/></div><div>我们需要在新建的迁移文件中为用户添加一个 is_admin 的布尔值字段类判断用户是否为管理, 该字段默认为 false , 在迁移文件执行时, 对该字段进行创建, 回滚时需要对该字段进行移除, 迁移文件最终如下:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">database/migrations/[timestamp]_add_is_admin_to_users_table.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Support\Facades\Schema;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Schema\Blueprint;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Migrations\Migration;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class AddIsAdminToUsersTable extends Migration</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * Run the migrations.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return void</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function up()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Schema::table('users', function (Blueprint $table) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;boolean('is_admin')-&gt;default(false);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * Reverse the migrations.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return void</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function down()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Schema::table('users', function (Blueprint $table) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;dropColumn('is_admin');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>可以看到我们使用了 dropColumn 方法来对指定字段进行移除</div><div><br/></div><div>在迁移文件创建成功之后, 我们还需要运行数据库迁移</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan migrate</div></div><div><br/></div><div>现在应用中还不存在管理员身份的用户, 让我们对数据填充文件进行更改, 将第一个生成的用户设置为管理员</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">database/seeds/UsersTableSeeder.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Seeder;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\User;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersTableSeeder extends Seeder</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * Run the database seeds.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return void</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function run()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $users = factory(User::class)-&gt;times(50)-&gt;make();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        User::insert($users-&gt;makeVisible(['password', 'remember_token'])-&gt;toArray());</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user = User::find(1);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;name = 'Aufree';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;email = '</span><a href="mailto:aufree@yousails.com" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">aufree@yousails.com</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;password = bcrypt('password');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;is_admin = true;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;save();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>我们在 each 方法的闭包函数中对第一位用户的指定字段进行了赋值操作, 接下里我们还需要修改用户模型工厂, 将其他生成的假用户管理员字段设置为 false</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">database/factories/UserFactory.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Faker\Generator as Faker;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">/*</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">|--------------------------------------------------------------------------</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">| Model Factories</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">|--------------------------------------------------------------------------</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">|</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">| This directory should contain each of the model factory definitions for</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">| your application. Factories provide a convenient way to generate new</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">| model instances for testing / seeding your application's database.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">|</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">*/</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$factory-&gt;define(App\Models\User::class, function (Faker $faker) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    $date_time = $faker-&gt;date . ' ' . $faker-&gt;time;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    static $password;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'name' =&gt; $faker-&gt;name,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'email' =&gt; $faker-&gt;safeEmail,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'is_admin' =&gt; false,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'password' =&gt; $password ?: $password = bcrypt('secret'),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'remember_token' =&gt; str_random(10),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'created_at' =&gt; $date_time,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'updated_at' =&gt; $date_time,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">});</span></div></div><div><br/></div><div>最后我们队数据库进行重置和填充</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan migrate:refresh --seed</div></div><div><br/></div><div>现在如果我们在 tinker 中进行查看, 可以看到第一位用户已经被设置为管理员</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan tinker</div></div><div><br/></div><div><img src="7.5--删除用户_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>destory 动作</div><div><br/></div><div>删除用户的动作, 有两个逻辑需要提前考虑</div><ol><li><div>只有当前登录用户才能执行删除操作</div></li><li><div>删除的用户对象不是自己,(即使是管理员也不能删除自己)</div></li></ol><div><br/></div><div>我们在开发更新用户功能的时, 已经创建了用户授权策略类, 让我们接着对该授权策略进行编辑, 加上 destory 删除用户动作的相关授权</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Policies/UserPolicy.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Policies;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Auth\Access\HandlesAuthorization;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\User;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UserPolicy</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    use HandlesAuthorization;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function update(User $currentUser, User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return $currentUser-&gt;id === $user-&gt;id;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function destroy(User $currentUser, User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return $currentUser-&gt;is_admin &amp;&amp; $currentUser-&gt;id !== $user-&gt;id;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div> 我们使用了下面这行代码来指明, 只有当前用户拥有管理员权限而且删除的用户不是自己时, 才能显示链接</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$currentUser-&gt;is_admin &amp;&amp; $currentUser-&gt;id !== $user-&gt;id;</div></div><div><br/></div><div>laravel 授权策略提供了 @can blade 命令, 允许我们在 blade 模板中做授权判断, 接下来, 我们利用 @can 指令, 在用户列表页加上只有管理员才能看到的删除用户按钮</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/views/users/_user.blade.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;img src=&quot;{{ $user-&gt;gravatar() }}&quot; alt=&quot;{{ $user-&gt;name }}&quot; class=&quot;gravatar&quot;/&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;a href=&quot;{{ route('users.show', $user-&gt;id )}}&quot; class=&quot;username&quot;&gt;{{ $user-&gt;name }}&lt;/a&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @can('destroy', $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;form action=&quot;{{ route('users.destroy', $user-&gt;id) }}&quot; method=&quot;post&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {{ csrf_field() }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {{ method_field('DELETE') }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;button type=&quot;submit&quot; class=&quot;btn btn-sm btn-danger delete-btn&quot;&gt;删除&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/form&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @endcan</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/li&gt;</span></div></div><div><br/></div><div>添加页面样式优化</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/assets/sass/app.scss</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">/* Users index */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.delete-btn {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  float: right;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  position: relative;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  right: 0;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>在管理员点击删除用户按钮之后, 删除动作会映射到用户控制器上面的 destroy 动作上, 让我们为控制器天添加基本的 用户删除动作</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function destroy(User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;delete();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        session()-&gt;flash('success', '成功删除用户！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return back();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>destroy 动作中, 我们首先根据路由发送过来的用户 id 进行数据查找, 查找到之后再调用 Eloquent 模型提供的 delete 方法对用户资源进行删除, 成功删除之后再页面顶部进行消息提示, 最后将用户重定向到上一次进行 删除的页面, 即用户列表页</div><div><br/></div><div>有上面的代码, 管理员已经可以进行删除操作了, 并且我们使用了 Auth 黑名单, 也就是说除了 except 数组中指定的动作, 其他的动作必须登陆后才能操作</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('auth', [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'except' =&gt; ['show', 'create', 'store', 'index']</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>另外还需要注意的一点是, 现在的删除动作是对所有的登录用户都开放的, 为此我们需要对删除动作加上授权策略, 只有已登录的管理员用户才能进行删除操作.</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function destroy(User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;authorize('destroy', $user);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;delete();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        session()-&gt;flash('success', '成功删除用户！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return back();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div>至此, 用户删除功能完成</div><div><br/></div><div><img src="7.5--删除用户_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 