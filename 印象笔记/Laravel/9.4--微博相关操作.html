<html>
<head>
  <title>9.4--微博相关操作</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1465"/>
<h1>9.4--微博相关操作</h1>

<div>
<span><div>微博的 CRUD </div><div><br/></div><div>现在微博已经可以正常显示, 接下来让我们来完成微博的创建和删除操作</div><div><br/></div><div>如果使用 resource 方法来定义微博路由, 则会生成完整的符合 RESTful 架构的路由, 但是我们完成微博的创建和删除只需要两个动作, 因此我们可以对 resource 传参 only 键指定只生成几个动作的路由</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">routes/web.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::resource('statuses', 'StatusesController', ['only' =&gt; ['store', 'destroy']]);</span></div></div><div><br/></div><div><br/></div><div>该路由信息如下</div><div><br/></div><div><img src="9.4--微博相关操作_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>访问限制</div><div><br/></div><div>在路由定义完成后, 我们需要生成一个微博动态控制器来处理微博的创建和删除操作</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan make:controller StatusesController</div></div><div><br/></div><div>由前面开发用户相关知识可以知道, 一些需要用户登录之后才能执行的请求需要通过中间件来过滤, 接下来我们开的 store 和 destory 动作将作用于微博的创建和删除, 这两个动作都需要用户登录, 因此让我们借助 Auht 中间件来为这两个动作添加请求</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/StatusesController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Http\Request;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Http\Requests;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class StatusesController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('auth');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>创建微博 </div><div><br/></div><div>下面让我们来完善创建微博的动作, 首先我们要对微博的内容进行限制, 一条微博的最长长度为 140 个字符, 且内容部位空, 通过前面的学习, 我们得到验证规则:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>'content' =&gt; 'required|max:140',</div></div><div><br/></div><div>当我们在创建微博的时候, 需要通过以下方式来创建, 这样创建的微博会自动与用户进行关联</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$user-&gt;statuses()-&gt;create();</div></div><div><br/></div><div>因为创建微博的用户始终为当前用户, 借助 laravel 提供的 Auth::user() 方法我们可以获取到当前用户实例, 在创建微博的时候, 我们需要对微博的内容进行赋值, 因此2最终的创建方法是</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Auth::user()-&gt;statuses()-&gt;create()([</div><div><span>    'content' =&gt; $request['content']</span></div><div>]);</div></div><div><br/></div><div>由于我们接下来会在主页上面显示微博发布表单和微博动态, 因此在用户完成微博的创建之后, 需要将其导向至上一次发送请求的页面, 即网站主页, 因此可以使用 back 方法来完成</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/StatusesController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Http\Request;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Http\Requests;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\Status;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Auth;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class StatusesController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('auth');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function store(Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'content' =&gt; 'required|max:140'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Auth::user()-&gt;statuses()-&gt;create([</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'content' =&gt; $request['content']</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;back();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>接下来让我们在主页上创建一个微博发布表单, 让用户可以发布微博, 对于微博表单我们还需要单独抽离成一个局部视图,. 保证代码的可维护性</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/views/shared/_status_form.blade.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;form action=&quot;{{ route('statuses.store') }}&quot; method=&quot;POST&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @include('shared._errors')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  {{ csrf_field() }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;textarea class=&quot;form-control&quot; rows=&quot;3&quot; placeholder=&quot;聊聊新鲜事儿...&quot; name=&quot;content&quot;&gt;{{ old('content') }}&lt;/textarea&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary pull-right&quot;&gt;发布&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/form&gt;</span></div></div><div><br/></div><div>为主页添加表单和当前个人信息</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/views/static_pages/home.blade.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@extends('layouts.default')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@section('content')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @if (Auth::check())</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;row&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div class=&quot;col-md-8&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;section class=&quot;status_form&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          @include('shared._status_form')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/section&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;aside class=&quot;col-md-4&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;section class=&quot;user_info&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          @include('shared._user_info', ['user' =&gt; Auth::user()])</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/section&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/aside&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @else</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;jumbotron&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;h1&gt;Hello Laravel&lt;/h1&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;p class=&quot;lead&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        你现在所看到的是 &lt;a href=&quot;</span><a href="https://laravel-china.org/laravel-tutorial/5.1" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">https://laravel-china.org/laravel-tutorial/5.1</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&quot;&gt;Laravel 入门教程&lt;/a&gt; 的项目主页。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        一切，将从这里开始。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;a class=&quot;btn btn-lg btn-success&quot; href=&quot;{{ route('signup') }}&quot; role=&quot;button&quot;&gt;现在注册&lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @endif</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@stop</span></div></div><div><br/></div><div><img src="9.4--微博相关操作_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>现在让我们发布一条微博会报错,</div><div><img src="9.4--微博相关操作_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>因为我们未在微博模型中定义 fillable 属性, 来指定在微博模型中可以进行正常更新的字段, laravel 在尝试保护. 解决的办法: 在微博模型的 fillable 中允许更新微博的 content 字段即可</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Models/Status.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Models;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Eloquent\Model;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Status extends Model</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected $fillable = ['content'];</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function user()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return $this-&gt;belongsTo(User::class);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div>动态流模型</div><div><br/></div><div>现在网站已经拥有微博的发布表单和当前登录用户的个人信息展示页面了, 加下来让我们接着完善.</div><div>在微博发布表单下面新增一个局部视图用于展示微博列表, 在开始之前, 我们需要在用户模型中定义一个 feed 方法, 该方法将当前用户发布过的所有微博从数据库中取出, 并根据创建时间来倒序排序, 在后面我们将为用户增加关注人的功能之后, 将使用该方法获取当前用户关注的人发布过的所有微博动态. 现在 feed 方法定义如下:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Models/User.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Models;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class User extends Authenticatable</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function feed()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return $this-&gt;statuses()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    -&gt;orderBy('created_at', 'desc');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>由于我们在用户模型中定义好了 feed 方法, 因此我们可以在主页对应的控制器动作 home 中使用该方法来获取用户的微博动态</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/StaticPagesController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Http\Request;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Http\Requests;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Http\Controllers\Controller;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\Status;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Auth;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class StaticPagesController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function home()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $feed_items = [];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if (Auth::check()) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $feed_items = Auth::user()-&gt;feed()-&gt;paginate(30);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('static_pages/home', compact('feed_items'));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function help()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('static_pages/help');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function about()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('static_pages/about');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div></div><div><br/></div><div>我们定义了一个空数组 feed_items 来保存微博动态数据, 由于用户在访问首页时, 可能存在登录或未登录两种状态, 因此我们需要确保当前用户已进行登录时才从数据库读取数据, 前面章节讲过. Auth::check() 检查用户是否已经登录</div><div><br/></div><div>现在让我们接着定义一个微博动态流局部视图, 用于渲染微博动态列表</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/views/shared/_feed.blade.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@if (count($feed_items))</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;ol class=&quot;statuses&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @foreach ($feed_items as $status)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @include('statuses._status', ['user' =&gt; $status-&gt;user])</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @endforeach</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  {!! $feed_items-&gt;render() !!}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/ol&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@endif</span></div></div><div><br/></div><div><br/></div><div>接着让该视图添加到网站主页上面</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/views/static_pages/home.blade.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@extends('layouts.default')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@section('content')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @if (Auth::check())</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;row&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div class=&quot;col-md-8&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;section class=&quot;status_form&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          @include('shared._status_form')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/section&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;h3&gt;微博列表&lt;/h3&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        @include('shared._feed')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;aside class=&quot;col-md-4&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;section class=&quot;user_info&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          @include('shared._user_info', ['user' =&gt; Auth::user()])</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/section&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/aside&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @else</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;jumbotron&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;h1&gt;Hello Laravel&lt;/h1&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;p class=&quot;lead&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        你现在所看到的是 &lt;a href=&quot;</span><a href="https://laravel-china.org/laravel-tutorial/5.1" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">https://laravel-china.org/laravel-tutorial/5.1</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&quot;&gt;Laravel 入门教程&lt;/a&gt; 的项目主页。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        一切，将从这里开始。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;a class=&quot;btn btn-lg btn-success&quot; href=&quot;{{ route('signup') }}&quot; role=&quot;button&quot;&gt;现在注册&lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @endif</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@stop</span></div></div><div><br/></div><div><img src="9.4--微博相关操作_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>删除微博</div><div><br/></div><div>心在已经能够看到数据展示了, 但是还不能删除</div><div><br/></div><div>我们需要授权用户进行删除的操作, 只有当悲伤出的微博作者为当前用户, 授权才能通过, 运行下面命令</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan make:policy StatusPolicy</div></div><div><br/></div><div>接下来添加删除按钮</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;li id=&quot;status-{{ $status-&gt;id }}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;a href=&quot;{{ route('users.show', $user-&gt;id )}}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;img src=&quot;{{ $user-&gt;gravatar() }}&quot; alt=&quot;{{ $user-&gt;name }}&quot; class=&quot;gravatar&quot;/&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;span class=&quot;user&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;a href=&quot;{{ route('users.show', $user-&gt;id )}}&quot;&gt;{{ $user-&gt;name }}&lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;span class=&quot;timestamp&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {{ $status-&gt;created_at-&gt;diffForHumans() }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;span class=&quot;content&quot;&gt;{{ $status-&gt;content }}&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @can('destroy', $status)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;form action=&quot;{{ route('statuses.destroy', $status-&gt;id) }}&quot; method=&quot;POST&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {{ csrf_field() }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {{ method_field('DELETE') }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;button type=&quot;submit&quot; class=&quot;btn btn-sm btn-danger status-delete-btn&quot;&gt;删除&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/form&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  @endcan</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/li&gt;</span></div></div><div><br/></div><div>接着定义微博控制器中的 destory 动作</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/StatusesController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Http\Request;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Http\Requests;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\Status;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Auth;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class StatusesController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('auth');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function store(Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'content' =&gt; 'required|max:140'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Auth::user()-&gt;statuses()-&gt;create([</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'content' =&gt; $request['content']</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;back();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function destroy(Status $status)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;authorize('destroy', $status);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $status-&gt;delete();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        session()-&gt;flash('success', '微博已被成功删除！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;back();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><img src="9.4--微博相关操作_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>删除功能开发完成</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 