<html>
<head>
  <title>7.3--权限系统</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1502"/>
<h1>7.3--权限系统</h1>

<div>
<span><div><div>权限系统</div><div><br/></div><div>现在的应用有两大隐患</div><ol><li><div>未登录的用户可以访问 edit 和 update 动作</div></li><li><div>登录用户可以更新其他用户的个人信息</div></li></ol><div><br/></div><div>接下来我们针对这两个问题进行优化</div><div><br/></div><div>必须先登录</div><div><br/></div><div>laravel 中间件(Middleware) 为我们提供了一种非常棒的过滤机制来过滤进入应用的 HTTP 请求, 例如, 当我们使用 Auth 中间件来验证用户的身份时, 如果用户未通过身份证, 则 Auth 中间件会把用户重定向到登录页面, 如果用户通过了身份验证, 则 Auth 中间件会通过此请求并接着往下执行, laravel 框架默认为我们内置了一些中间件, 例如身份验证, CSRF保护等, 所有中间件文件都被放在项目的 app/Http/Middleware 文件夹中.</div><div><br/></div><div>接下来让我们使用 laravel 提供身份验证(Auth) 中间件过滤未登录用户的 edit update 动作</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('auth', [            </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'except' =&gt; ['show', 'create', 'store']</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>我们通过构造方法调用 middleware 方法, 该方法接收两个参数, 第一个为中间件的名称, 第二个为要进行过滤的动作, 我们通过 except 方法来设定 指定动作不使用 Auth 中间件过滤机制, 意为除了此处指定的动作之外, 所有的其他动作都必须登录用户才能访问, 类似于黑名单的过滤机制, 相反的还有 only 白名单方法, 将只过滤指定动作. 我们提倡在控制器 Auth 中间件使用中, 首选 except 方法, 这样的话, 当你新增一个控制器方法时, 默认是安全的, 此为最佳实践.</div><div><br/></div><div>laravel 提供的 Auth 中间件在过滤指定动作时, 如果该用户未通过身份验证(未登录用户), 默认将会被重定向到 /login 登录页面</div><div><br/></div><div>此时退出登录, 再次访问 http://sample.test/users/1/edit 页面将会被重定向到登录页面</div><div><br/></div><div><br/></div><div>用户只能编辑自己的资料</div><div><br/></div><div>在完成对未登录用户的限制之后, 接下来我们要限制的是已登录用户的操作, 当 id 为 1 的用户去尝试更新 id 为 2 的用户信息时, 我们应该返回一个 403 禁止访问的异常, 在laravel 中可以使用 授权策略(Policy) 来对用户的操作权限进行验证, 在用户未经授权进行操作时将返回 403 禁止访问的异常</div><div><br/></div><div>我们可以通过命令生成一个名为 UserPolicy 的授权策略文件, 用于管理用户模型的授权</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan make:policy UserPolicy</div></div><div><br/></div><div>所有生成的授权策略问价都将会被放置在 app/Policy 下面</div><div><br/></div><div>让我们为默认生成的用户授权策略添加 update 方法, 用于用户更新时的权限验证</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Policies/UserPolicy.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Policies;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Auth\Access\HandlesAuthorization;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\User;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UserPolicy</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    use HandlesAuthorization;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function update(User $currentUser, User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return $currentUser-&gt;id === $user-&gt;id;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>upate 方法接受两个参数, 第一个参数默认为当前登录用户实例, 第二个参数为要进行验证的用户实例, 当两个实例 id 相同的时候, 用户通过授权, 可以接着下一个操作, 如果 id 不相同, 验证未通过, 抛出 403 异常信息来拒绝访问</div><div><br/></div><div>使用授权策略需要注意一以下两点</div><ol><li><div>我们不需要检查 $currentUser 是不是 null .未登录用户 , 框架会自动为其 所有权限放回 false </div></li><li><div>调用时, 默认情况下, 我们不需要传递当前登录用户至该方法内, 因为框架会自动加载当前登录用户</div></li></ol><div><br/></div><div>接下来我们还需要在 AuthServiceProvider 类中对授权策略进行设置, AuthServicePrivider 包含了一个 policies  属性, 该属性用于将各种模型对应到管理他们的授权策略上. 我们需要用户模型 User 指定授权策略 UserPolicy.</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Providers/AuthServiceProvider.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Providers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class AuthServiceProvider extends ServiceProvider</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * The policy mappings for the application.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @var array</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected $policies = [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'App\Model' =&gt; 'App\Policies\ModelPolicy',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        \App\Models\User::class  =&gt; \App\Policies\UserPolicy::class,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>授权策略完成之后, 我们便可以通过用户控制器中使用 authorize 方法来验证用户授权策略. 默认的 App\Http\Controllers\Controller 类中包含了 laravel 的 AuthorizesRequests trait . 此 trait 提供了 authorize 方法, 他可以被用于快速授权一个指定的行为, 当无权限运行该方法时会抛出 HttpException. authorize 方法接受两个参数, 第一个为授权策略的名称. 第二个进行授权验证的数据</div><div><br/></div><div>我们需要为 edit 和 update 方法加上这行</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$this-&gt;authorize('update',$user);</div></div><div><br/></div><div>这里的 update 是指授权类里的 update 授权方法, $user 对应传参 uodate 授权方法的第二个阐述, 正如上面定义 update 授权方法时候提到的, 调用时, 默认 情况下, 我们 不需要传递第一个参数, 也就是当前登录用户至该方法时, 因为框架会自动加载当前登录用户. </div><div><br/></div><div>书写的位置如下</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function edit(User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;authorize('update', $user);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('users.edit', compact('user'));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function update(User $user, Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name' =&gt; 'required|max:50',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'password' =&gt; 'nullable|confirmed|min:6'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;authorize('update', $user);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $data = [];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $data['name'] = $request-&gt;name;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if ($request-&gt;password) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $data['password'] = bcrypt($request-&gt;password);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;update($data);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        session()-&gt;flash('success', '个人资料更新成功！');</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;route('users.show', $user-&gt;id);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>最后我们用两个账户测试一下</div><div><br/></div><div><img src="7.3--权限系统_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div>友好的转向</div><div> </div><div>当一个未登录的用户尝试访问自己的资料编辑页面时, 会自动跳转到登录页面, 这时候如果用户再进行登录, 则会重定向到个人页面上面, 这种用户体验并不好, 更好的做法是, 将用户重定向到他之前尝试访问的页面, 及自己的个人编辑页面, redirect() 实例提供了一个 intended 方法, 该方法可将页面重定向到上一次请求尝试访问的页面上, 并接收一个默认跳转地址参数, 当上一次请求记录为空时, 跳转到默认地址上</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/SessionsController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class SessionsController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function store(Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       $credentials = $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'email' =&gt; 'required|email|max:255',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'password' =&gt; 'required'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       if (Auth::attempt($credentials, $request-&gt;has('remember'))) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           session()-&gt;flash('success', '欢迎回来！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           return redirect()-&gt;intended(route('users.show', [Auth::user()]));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       } else {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           session()-&gt;flash('danger', '很抱歉，您的邮箱和密码不匹配');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           return redirect()-&gt;back();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>现在尝试退出登录, 访问 users/1/edit 页面, 会重定向到登录页面,</div><div><br/></div><div><br/></div><div>注册于登录页面访问限制</div><div><br/></div><div>现在我们还有个小问题, 即已登录用户还能对注册页面和登录页面进行访问</div><div><br/></div><div>这明显不符合常规逻辑</div><div><br/></div><div>我们除了通过 Auth 中间件的 auth 属性来对控制器一些动作 进行过滤, 只允许已登录用户访问之外, 还可以使用 Auth 中间件提供的 guest 选项, 用于指定一些只允许未登录用户访问的动作, 因此我们需要通过对 guest 属性进行设置, 只让未登录用户访问登录页面和注册页面</div><div><br/></div><div>只让未登录用户访问登录页面</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/SessionsController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class SessionsController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('guest', [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'only' =&gt; ['create']</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div>只让未登录用户访问注册页面</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('auth', [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'except' =&gt; ['show', 'create', 'store']</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('guest', [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'only' =&gt; ['create']</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}    </span></div></div><div><br/></div><div>这时候访问 ../login 会自动跳转到 /home 页面, 因为登录和注册界面只有未登录用户才能使用</div><div><br/></div><div>我们需要修改中间件中的 redirect90 方法 加上友好的提示</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Middleware/RedirectIfAuthenticated.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class RedirectIfAuthenticated</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function handle($request, Closure $next, $guard = null)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if (Auth::guard($guard)-&gt;check()) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            session()-&gt;flash('info', '您已登录，无需再次操作。');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            return redirect('/');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><img src="7.3--权限系统_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 