<html>
<head>
  <title>1.08 -- 组件的 state 和 setState</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1365"/>
<h1>1.08 -- 组件的 state 和 setState</h1>

<div>
<span><div>state </div><div><br/></div><div>前面我们提到过, 一个组件的显示形态是可以由它数据状态和配置参数决定的. 一个组件可以拥有自己的状态, 就像一个点赞按钮, 可以由 &quot;已点赞&quot; 和 &quot;未点赞&quot; 状态, 并且可以在两种状态之间进行切换. React.js 的 state 就是用来存储这种可变化的状态的.</div><div><br/></div><div>我们还是拿点赞按钮做例子, 它具有两种状态. 那么就可以把这个状态存储在 state 中. 修改 src/index.js 为:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">import React, { Component } from 'react'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">import ReactDOM from 'react-dom'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">import './index.css'</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class LikeButton extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = { isLiked: false }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleClickOnLikeButton () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      isLiked: !this.state.isLiked</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;button onClick={this.handleClickOnLikeButton.bind(this)}&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {this.state.isLiked ? '取消' : '点赞'} 👍</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>isLiked 存放在实例的 state 对象当中, 这个对象在构造函数里面初始化. 这个组件的 render 函数内, 会根据组件的 state 的中的 isLiked 不同显示 &quot;取消&quot; 或 &quot;点赞&quot; 内容. 并且给 button 加上点击的事件监听.</div><div><br/></div><div>最后构建一个 Index, 在它的 render 函数内部使用 LikeButton. 然后把 Index 渲染到页面上:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Index extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;LikeButton /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ReactDOM.render(</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;Index /&gt;,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  document.getElementById('root')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">)</span></div></div><div><br/></div><div><b>setState 接受对象参数</b></div><div><br/></div><div>在 handleClickOnButton 事件监听函数里面, 大家可以留意到, 我们调用了 setState 函数, 每次点击都会更新 isLiked 属性为 !isLiked, 这样就可以做到点赞和取消功能.</div><div><br/></div><div>setState 方法由父类 Component 所提供的. 当我们调用这个函数的时候, React.js 会更新组件的状态 state, 并且重新调用 render 方法,然后再把 render 方法所渲染的最新内容显示在页面上.</div><div><br/></div><div>注意, 当我们要改变组件的状态的时候, 不能直接用 this.state = xxx 这种方式来修改, 如果这样做 React.js 就没办法知道你修改了组件的状态, 它也就没办法更新页面. 所以, 一定要使用 React.js 提供的 setState 方法, 它接受一个对象或者函数作为参数.</div><div><br/></div><div>传入一个对象的时候, 这个对象表示该组件的新状态. 但你只需要传入需要更新的部分就可以了, 而不需要传入整个对象. 例如, 假设现在我们有另外一个状态 name:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor (props) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super(props)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      name: 'Tomy',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      isLiked: false</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleClickOnLikeButton () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      isLiked: !this.state.isLiked</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>因为点击的时候我们并不需要修改 name, 所以只需要传入 isLiked 就行了. Tomy 还是那个 Tomy, 而 isLiked 已经不是那个 isLiked 了.</div><div><br/></div><div><b>setState 接受函数参数</b></div><div><br/></div><div>这里还有要注意的是, 当你调用 setState 的时候, React.js 并不会马上修改 state. 而是把这个对象放到一个更新队列里面, 稍后才会从队列当中把新的状态提取出来合并到 state 当中, 然后再触发组件更新. 这一点要好好注意:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleClickOnLikeButton () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    console.log(this.state.isLiked)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      isLiked: !this.state.isLiked</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    console.log(this.state.isLiked)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>你会发现两次打印的结果都是 false, 即使我们中间已经 setState 过一次了. 这并不是什么 bug, 只是 React.js 的 setState 把你传进来的状态缓存起来, 稍后才会帮你更新到 state 上, 所以你获取到的还是原来的 isLiked.</div><div><br/></div><div>所以你想在 setState 之后使用新的 state 来做后续运算就做不到了, 例如:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleClickOnLikeButton () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({ count: 0 }) // =&gt; this.state.count 还是 undefined</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({ count: this.state.count + 1}) // =&gt; undefined + 1 = NaN</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({ count: this.state.count + 2}) // =&gt; NaN + 2 = NaN</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>上面的代码运算结果并不能达到我们的预期, 我们希望 count 运行结果是 3, 可是最后得到的是 NaN. 但是这种后续操作依赖前一个 setState 的结果的情况并不罕见.</div><div><br/></div><div>这里就自然引出了 setState 的第二种使用方式, 可以接受一个函数作为参数. React.js 会把上一个 setState 的结果传入这个函数, 你局可以使用该结果进行运算, 操作, 然后返回一个对象作为更新 state 的对象:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleClickOnLikeButton () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState((prevState) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      return { count: 0 }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState((prevState) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      return { count: prevState.count + 1 } // 上一个 setState 的返回是 count 为 0，当前返回 1</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState((prevState) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      return { count: prevState.count + 2 } // 上一个 setState 的返回是 count 为 1，当前返回 3</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    // 最后的结果是 this.state.count 为 3</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>这样就可以到达上述所想要的运算效果.</div><div><br/></div><div>setState 合并</div><div><br/></div><div>上面我们进行了三次 setState, 但是实际上组件只会重新渲染一次, 而不是三次; 这是因为在 React.js 内部会把 JavaScript 事件循环中的消息队列的同一个消息中的 setState 都进行合并以后再重新渲染组件.</div><div><br/></div><div>深层的原理不需要过度纠结, 只需要记住: 在使用 React.js 的时候, 并不需要担心多次进行 setState 会带来性能问题.</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 