<html>
<head>
  <title>PHP 使用 CURL 详解</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1363"/>
<h1>PHP 使用 CURL 详解</h1>

<div>
<span><div><div>CURL 是一个非常强大的开源库, 支持很多协议, 包括 HTTP, FTP, TELNET 等, 我们使用它来发送 HTTP请求. 它给我们带来的好处是可以通过灵活的选项设置不同的 HTTP 协议参数, 并且支持 HTTPS. CURL 可以根据 URL 前缀是 &quot;HTTP&quot; 还是 &quot;HTTPS&quot; 自动选择是否加密发送内容.</div><div><br/></div><div><b>使用 CURL 发送请求的基本流程</b></div><div><br/></div><div>使用 CURL 的 PHP 扩展完成一个 HTTP 请求的发送一般有以下几个步骤:</div><ol><li><div>初始化连接句柄;</div></li><li><div>设置 CURL 选项;</div></li><li><div>执行并获取结果;</div></li><li><div>释放 VURL 连接句柄.</div></li></ol><div><br/></div><div>下面是使用 CURL 发送 HTTP 的典型过程</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 1. 初始化</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ch = curl_init();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><br/></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 2. 设置选项，包括URL</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($ch,CURLOPT_URL,&quot;http://www.devdo.net&quot;);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($ch,CURLOPT_HEADER,0);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><br/></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 3. 执行并获取HTML文档内容</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$output = curl_exec($ch);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">if($output === FALSE ){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span>    </span>echo &quot;CURL Error:&quot;.curl_error($ch);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><br/></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 4. 释放curl句柄</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_close($ch);</span></div></div><div><br/></div><div>上面代码中使用了四个函数</div><ul><li><div>curl_init() 和 curl_close() 分别是初始化 CURL 连接和关闭 CURL 连接, 都比较简单.</div></li><li><div>curl_exec() 执行 CURL 请求, 如果没有错误发生, 该函数的返回是对应 URL 返回的数据, 以字符串表示满意; 如果发生错误, 该函数返回 FALSE. 需要注意的是, 判断输出是否为 FALSE 用的是全等号, 这是为了区分返回空串和出错的情况.</div></li><li><div>CURL 函数库里最重要的是 curl_setopt(), 它可以通过设定 CURL 函数库定义的选项来定制 HTTP 请求. 上述代码片段中使用了三个重要的选项:</div></li><ul><li><div>CURLOPT_URL 指定请求的 URL;</div></li><li><div>CURLOPT_RETURNTRANSFER 设置为 1 表示稍后执行的 curl_exec 函数的返回是 URL 的返回字符串, 而不是把返回字符串定向到标准输出并返回 TRUE;</div></li><li><div>CURLOPT_HEADER 设置为 0 表示不返回 HTTP 头部信息.</div></li></ul></ul><div><br/></div><div>CURL 选项还有很多, 可以到 PHP 官网上查看 CURL 支持的所有选项列表.</div><div><br/></div><div><b>获取 CURL 请求的输出信息</b></div><div><br/></div><div>在 curl_exec() 函数执行后, 可以使用 curl_getinfo() 函数获取 CURL 请求输出的相关信息, 示例代码如下:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_exec($ch);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$info = curl_getinfo($sh);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">echo ' 获取 '.$info['url'].'耗时'.$info['total_time'].'秒';</span></div></div><div><br/></div><div>上述代码中 curl_getinfo 返回的是一个关联数组, 包含以下数据:</div><ul><li><div>url: 网络地址</div></li><li><div>content_type: 内容编码</div></li><li><div>http_code: HTTP 状态码</div></li><li><div>header_size: header 的大小</div></li><li><div>request_size: 请求的大小</div></li><li><div>filetime: 文件创建的时间</div></li><li><div>ssl_verify_result: SSL 验证结果</div></li><li><div>redirect_count: 跳转计数</div></li><li><div>total_time: 总耗时</div></li><li><div>namelookup_time: DNS 查询耗时</div></li><li><div>connect_time: 等待连接耗时</div></li><li><div>pretransfer_time: 传输前准备耗时</div></li><li><div>size_upload: 上传数据的大小</div></li><li><div>size_download: 下载数据的大小</div></li><li><div>speed_download: 下载速度</div></li><li><div>speed_upload: 上传速度</div></li><li><div>download_content_length: 下载内容的长度</div></li><li><div>upload_content_length: 上传内容的长度</div></li><li><div>starttransfer: 开始传输的时间表</div></li><li><div>redirect_time: 重定向耗时</div></li></ul><div><br/></div><div>curl_getinfo() 函数还有一个可选参数 $opt, 通过这个参数可以设置一些常量, 对应到上述这个字段, 如果设置了第二个参数, 那么返回的只有指定的信息. 例如设置 $opt 为 CURLINFO_TOTAL_TIME, 则 curl_getinfo() 函数只返回 total_time, 即总传输耗时的时间, 在只需要关注某些传输信息的时候, 设置 &amp;opt 参数很有意义.</div><div><br/></div><div><b>使用 CURL 发送 GET 请求</b></div><div><br/></div><div>如何使用 CURL 来发送 GET 请求, 发送 GET 请求的关键是拼接格式正确的 URL. 请求地址和 GET 数据由一个 &quot;?&quot; 分割, 然后 GET 变量的名称和值用 &quot;=&quot; 分隔, 各个 GET 名称和值由 &quot;&amp;&quot; 连接. PHP 为我们提供了一个函数专门用来拼接 GET 请求和数据部分 --- http_build_query, 该函数接受一个关联数组, 返回由该关联数组描述的 GET 请求字符串. 使用这个函数, 结合 CURL 发送 HTTP 请求的一般请求, 我们封闭了一个发送 GET 请求的函数 --- doCurlGetRequest, 具体代码:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">*@desc 封闭curl的调用接口，get的请求方式。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">*/</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function doCurlGetRequest($url,$data,$timeout = 5){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span>    </span>if($curl == &quot;&quot; || $timeout &lt;= 0){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span>    </span>return false;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$url = $url.'?'.http_bulid_query($data);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$con = curl_init((string)$url);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($con, CURLOPT_HEADER, false);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($con, CURLOPT_RETURNTRANSFER,true);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($con, CURLOPT_TIMEOUT, (int)$timeout);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><br/></span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">return curl_exec($con);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>这个函数把使用 http_build_query 拼装好的带 GET 参数的 URL 传给 curl_init 函数, 然后使用 CURL 发送 HTTP 请求.</div><div><br/></div><div>使用 CURL 发送 POST 请求</div><div><br/></div><div>可以使用 CURL 提供的选项 CURLOPT_POSTFIELDS, 设置该选项为 POST 字符串数据就可以请求放在正文中. 同样我们实现了一个发送 POST 请求的函数 ---- doCurlPostRequest, 代码如下:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">/**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">** @desc 封装 curl 的调用接口，post的请求方式</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">**/</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function doCurlPostRequest($url,$requestString,$timeout = 5){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span>    </span>if($url == '' || $requestString == '' || $timeout &lt;=0){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span>    </span>return false;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$con = curl_init((string)$url);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($con, CURLOPT_HEADER, false);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($con, CURLOPT_POSTFIELDS, $requestString);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($con, CURLOPT_POST,true);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($con, CURLOPT_RETURNTRANSFER,true);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">curl_setopt($con, CURLOPT_TIMEOUT,(int)$timeout);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">return curl_exec($con);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>上面代码中除了设置 CURLOPT_POSTFIELDS 外, 我们还设置了 CURL_POST 为 true, 标识这个请求是一个 POST 请求. 在 POST 请求中也是可以传输 GET 数据的, 只需要在 URL 中拼装 GET 请求数据即可.</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 