<html>
<head>
  <title>6.2--会话</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1518"/>
<h1>6.2--会话</h1>

<div>
<span><div><div>会话</div><div><br/></div><div>由于 Http 协议是无状态的, 我们无法在两个页面之间保证用户身份的同步, 因此我们需要借助在浏览器中临时存储用户的身份信息, 进而保证在同一浏览器中, 用户在不同页面具有相同登录状态</div><div><br/></div><div>接下来新建分支, 开始登录登出功能的开发</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ git checkout master</div><div>$ git checkout -b login-logout</div></div><div><br/></div><div>会话控制器,</div><div><br/></div><div>首先我们需要新建一个会话控制器, 该控制器将用于处理用户登录登出相关的操作, 你可以把它理解为我们之前提到过的资源, 当用户登陆成功时, 会话将会被创建, 退出登录, 会话被销毁, 只是在这里会话并不会保存到数据库中, 而是保存在浏览器上, 让我们运行下面的命令来生成会话控制器</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan make:controller SessionsController</div></div><div><br/></div><div>下面我们还要对路由进行配置, 添加一些接下来需要用到的路由, 新增的路由分别对应会话控制器的三个动作: create store destory</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">routes/web.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('/', 'StaticPagesController@home')-&gt;name('home');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('/help', 'StaticPagesController@help')-&gt;name('help');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('/about', 'StaticPagesController@about')-&gt;name('about');</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('signup', 'UsersController@create')-&gt;name('signup');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::resource('users', 'UsersController');</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('login', 'SessionsController@create')-&gt;name('login');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::post('login', 'SessionsController@store')-&gt;name('login');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::delete('logout', 'SessionsController@destroy')-&gt;name('logout');</span></div></div><div><br/></div><div>新增的路由功能如下:</div><div><br/></div><div><img src="6.2--会话_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>你也可以使用 Laravel 提供的 route:list 命令来查看已添加的路由</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">$ php artisan route:list</span></div></div><div><br/></div><div>我们可以通过此命令更好的了解 php 框架</div><div><br/></div><div><br/></div><div>登录表单</div><div><br/></div><div>在用户填写登录表单时, 只需要用户提供个人邮箱账号和密码信息即可, 由于我们之前给邮箱做了唯一性限制, 因此能够保证所有的注册用户邮箱都不同, 为了确认登陆者为邮箱拥有者本人, 我们需要将邮箱密码进行匹配, 匹配成功的用户将通过认证并登录</div><div><br/></div><div>接下来我们完善一开始创建的会话控制器, 加入 create 动作, 并返回一个指定的登录视图</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/SessionsController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Http\Request;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Http\Requests;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class SessionsController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function create()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('sessions.create');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>让我们新建一个登录视图, 并加上表单信息</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/views/sessions/create.blade.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@extends('layouts.default')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@section('title', '登录')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@section('content')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;div class=&quot;col-md-offset-2 col-md-8&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;div class=&quot;panel panel-default&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;panel-heading&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;h5&gt;登录&lt;/h5&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;panel-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      @include('shared._errors')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;form method=&quot;POST&quot; action=&quot;{{ route('login') }}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          {{ csrf_field() }}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;label for=&quot;email&quot;&gt;邮箱：&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;input type=&quot;text&quot; name=&quot;email&quot; class=&quot;form-control&quot; value=&quot;{{ old('email') }}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          &lt;/div&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;label for=&quot;password&quot;&gt;密码：&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;input type=&quot;password&quot; name=&quot;password&quot; class=&quot;form-control&quot; value=&quot;{{ old('password') }}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          &lt;/div&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;登录&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/form&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;hr&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;p&gt;还没账号？&lt;a href=&quot;{{ route('signup') }}&quot;&gt;现在注册！&lt;/a&gt;&lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@stop</span></div></div><div><br/></div><div>上面构建的表单中有一行我们需要特别关注</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;form method=&quot;POST&quot; action=&quot;{{ route('login') }}&quot;&gt;</span></div></div><div><br/></div><div>我们在前面新增的路由中, 有两个路由的命名完全一致, 但是由于我们在表单中清楚的指明了使用 POST 动作来提交用户的登录信息, 因此 Laravel 会自动将该请求映射到会话控制器的 store 上</div><div><br/></div><div>这时候访问 sample.test/login 页面已经能够看到登录页面可以正常显示, 但现在表单仍然处于不可用状态, 因为我们还没有对用户发送的登录请求做任何处理</div><div><br/></div><div><br/></div><div><br/></div><div>认证用户身份</div><div><br/></div><div>Laravel 默认提供的内置认证控制器功能非常强大, 只需要你做简单的几行代码配置即可完成整个登录功能的构建, 但是在本教程中, 为了让新手对整个用户登录流程有更加清楚的了解, 为此我们将使用手动认证的方式来一步步实现用户的登录功能</div><div><br/></div><div>在我们成功构建用户的登录表单之后, 我们需要在会话控制器中创建 store 动作来对用户提交的数据进行验证</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/SessionsController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Http\Request;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Http\Requests;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class SessionsController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function create()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('sessions.create');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function store(Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       $credentials = $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'email' =&gt; 'required|email|max:255',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'password' =&gt; 'required'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       return;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>我们可以看到, 在 store 动作中的数据验证和之前的有所不同, 因为在这里只需要保证用户输入的值不为空且格式正确即可,</div><div><br/></div><div>当用户填写的信息验证通过之后, 我们还需要对用户提供的信息进行用户身份认证, 因为验证通过只能说明用户提交的信息格式是正确的, 但是不能保证用户信息是否存在于数据库中</div><div><br/></div><div>我么可以使用 Illuminate\Http\Request 实例来接受用户所有输入数据, 当我们需要取出 Requests 实例的单个值</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$request-&gt;email;</div></div><div><br/></div><div>当 $request 请求中包含 email 字段时, 上面这行代码将返回邮箱信息</div><div><br/></div><div>借助 laravel 的 Auth 的 attempt 方法可以让我们很方便的完成用户的身份认证操作</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>if (Auth:attempt(['email' =&gt; $email, 'password' =&gt; $password])){</div><div><span>    // 还用户存在并且输入信息一致</span><br/></div><div>}</div></div><div><br/></div><div>attempt 方法会接收一个数组来作为第一个参数, 该参数提供的值将用于寻找数据库中的用户数据, 因此在上面的例子中, attempt 方法执行的代码逻辑如下:</div><ol><li><div>使用 email 字段的值在数据库中进行查找</div></li><li><div>如果用户被找到, </div></li></ol><div><span>    </span><span>    </span><span>    1) 将传参的 password 值进行哈希加密, 然后与数据库中的password 字段中已加密的密码进行匹配</span><br/></div><div><span><span>    </span><span>    </span><span>    2) 如果匹配后两个值完全一致, 会创建一个会话给通过的用户, 会话在创建的同时, 也会种下一个名为 laravel_session 的 HTTPCookie. 以此cookie 来记录用户的登录状态, 最终返回 true</span><br/></span></div><div><span><span>    </span><span>    </span><span>    3) 如果不匹配, 则返回 false</span><br/></span></div><ol start="3"><li><div>如果用户并未被找到, 返回 false<br/></div></li></ol><div><br/></div><div>结合 atempt 方法对用户身份进行认证的具体代码如下, 使用 Auth 前需要对其进行引用</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/SessionsController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Auth;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class SessionsController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function store(Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       $credentials = $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'email' =&gt; 'required|email|max:255',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'password' =&gt; 'required'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       if (Auth::attempt($credentials)) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           // 登录成功后的相关操作</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       } else {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           // 登录失败后的相关操作</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       return;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div>消息提示以及页面重定向</div><div><br/></div><div>现在 store 方法已经能够万恒用户身份的认证操作了, 接下来我们需要针对用户认证成功或失败的情况做不同处理.</div><div>登录失败时, 需要在顶部提示信息, 并且重定向到登录页面</div><div><br/></div><div>在用户登录失败之后吗我们试用以下代码</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>session()-&gt;flash('danger', '用户名与密码不匹配!');</div></div><div><br/></div><div>由于 danger 在 bootstrsap 中有着特殊含义, 借助我们在前面章节定义的消息提示局部视图, 可以使得页面上的消息提示更加美观 </div><div><br/></div><div>在用户登录成功之后我还需要将用户重定向到个人页面(你想让他定向到的地方), 让用户可以第一时间查看自己的信息, 而当用户登录失败之后, 让他尝试重新登录, 接下来我们接着完善 store 方法, 加入消息提示和页面重定向操作.</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/SessionsController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class SessionsController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function store(Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       $credentials = $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'email' =&gt; 'required|email|max:255',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'password' =&gt; 'required'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       if (Auth::attempt($credentials)) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           session()-&gt;flash('success', '欢迎回来！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           return redirect()-&gt;route('users.show', [Auth::user()]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       } else {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           session()-&gt;flash('danger', '很抱歉，您的邮箱和密码不匹配');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           return redirect()-&gt;back();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>我们在 store 方法内使用了 Laravel 提供的 Auth::user() 方法来提取 当前登录用户 的信息, 并将数据传送给路由</div><div><br/></div><div>我们来试一试:</div><div><br/></div><div><img src="6.2--会话_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><img src="6.2--会话_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 