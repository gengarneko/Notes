<html>
<head>
  <title>8.2--账户激活</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1490"/>
<h1>8.2--账户激活</h1>

<div>
<span><div><div>账户激活</div><div><br/></div><div>现在的登录逻辑是, 用户一旦注册成功即可进行登录, 本章节我们要加入账号激活功能, 只有当用户成功激活自己的账号时才能在网站上进行登录, 为此, 我们需要为用户表新增两个字段用于保存用户的激活令牌和激活状态. 激活令牌用于验证用户身份, 激活状态用于判断用户是否已经激活</div><div><br/></div><div>整个激活流程如下：</div><ol><li><div>用户注册成功后, 自动生成激活令牌</div></li><li><div>将激活令牌以链接的方式附带在注册邮件里面, 并将邮件发送到用户的注册邮箱上面</div></li><li><div>用户点击注册链接跳转到指定路由, 路由收到激活令牌参数后映射给相关控制器动作处理</div></li><li><div>控制器拿到激活令牌进行验证, 验证通过后对该用户进行激活, 并将其激活状态设置为已激活</div></li><li><div>用户激活成功, 自动登录</div></li></ol><div><br/></div><div>接下来让我们跟之前一样, 新建一个 git 分支来开发新的功能</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ git checkout master</div><div>$ git checkout -b account-activation-password-resets</div></div><div><br/></div><div><br/></div><div><br/></div><div>资源</div><div><br/></div><div>添加字段</div><div><br/></div><div>在用户的账号激活功能中, 我们需要为激活令牌 (activation_token) 和激活状态 (activatied ) 字段新增一个迁移, 来将这两个字段添加到用户表中, 由于我们进行的是字段添加操作, 因此命名迁移文件的时候需要加上前缀, 遵照 add_column_to_table 的命名规范, 并在生成迁移文件的命令中启用 --table 项目,  用于指定对应的数据库表, 如下</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan make:migration add_activation_to_users_table --table=users</div></div><div><br/></div><div>我们将随机字符来生成用户的激活令牌, 因此这里的激活令牌字段需要为 string 类型, 在用户成功激活以后, 我们还会对激活令牌进行清空, 避免用户进行多次使用, 因此我们还需要将字段设置为 nullable ,代表该字段允许为空, 而用户的激活状态只有已激活和未激活两种状态, 默认为未激活的状态, 因此我们可以将激活状态设置为 boolean 类型, 当其值为 true , 代表已激活</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">database/migrations/[timestamp]_add_activation_to_users_table.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Support\Facades\Schema;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Schema\Blueprint;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Migrations\Migration;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class AddActivationToUsersTable extends Migration</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * Run the migrations.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return void</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function up()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Schema::table('users', function (Blueprint $table) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;string('activation_token')-&gt;nullable();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;boolean('activated')-&gt;default(false);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * Reverse the migrations.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return void</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function down()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Schema::table('users', function (Blueprint $table) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;dropColumn('activation_token');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;dropColumn('activated');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>对 migrate 文件进行迁移, 将字段添加到数据库中</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ php artisan migrate</div></div><div><br/></div><div><br/></div><div>生成令牌</div><div><br/></div><div>用户的激活令牌需要在用户创建之前就先生成好, 这样当用户注册成功之后我们才能将令牌附带到注册链接上, 并通过邮件的形式发送给用户</div><div><br/></div><div>如果我们需要在模型被创建之前进行一些设置, 则可以监听 creating 方法来做到, 该方法是由 Eloquent模型触发的一个事件. 事件是 laravel 提供一种简单的监听器实现, 我们可以对事件进行监听和订阅, 从而在事件被触发时接收到响应并执行一些指定操作, Eloquent 模型默认提供多个事件, 我们可以通过提供的事件来监听模型的创建, 更新, 删除, 保存等操作, creating 用于监听模型被创建之前的事件, created 用于监听模型被创建之后的事件, 接下来我们要生成的哟惊呼激活令牌需要在用户模型创建之前生成, 因此需要监听的是 creating 方法</div><div><br/></div><div>在用户模型中添加 creating 事件</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Models/User.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Models;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class User extends Authenticatable</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected $hidden = ['password', 'remember_token'];</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public static function boot()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        parent::boot();</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        static::creating(function ($user) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $user-&gt;activation_token = str_random(30);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>boot 方法会在用户模型完成初始化之后进行加载, 因此我们对事件的监听需要放在该方法之中,</div><div><br/></div><div>现在我们需要更新模型工厂, 将生成的假用户和第一位用户都设置为已激活装填</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">database/factories/UserFactory.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Faker\Generator as Faker;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">/*</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">|--------------------------------------------------------------------------</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">| Model Factories</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">|--------------------------------------------------------------------------</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">|</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">| This directory should contain each of the model factory definitions for</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">| your application. Factories provide a convenient way to generate new</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">| model instances for testing / seeding your application's database.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">|</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">*/</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$factory-&gt;define(App\Models\User::class, function (Faker $faker) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    $date_time = $faker-&gt;date . ' ' . $faker-&gt;time;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    static $password;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'name' =&gt; $faker-&gt;name,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'email' =&gt; $faker-&gt;safeEmail,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'is_admin' =&gt; false,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'activated' =&gt; false,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'password' =&gt; $password ?: $password = bcrypt('secret'),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'remember_token' =&gt; str_random(10),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'created_at' =&gt; $date_time,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'updated_at' =&gt; $date_time,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">});</span></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">database/seeds/UsersTableSeeder.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Seeder;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\User;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersTableSeeder extends Seeder</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * Run the database seeds.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return void</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function run()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $users = factory(User::class)-&gt;times(50)-&gt;make();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        User::insert($users-&gt;makeVisible(['password', 'remember_token'])-&gt;toArray());</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user = User::find(1);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;name = 'Aufree';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;email = '</span><a href="mailto:aufree@yousails.com" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">aufree@yousails.com</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;password = bcrypt('password');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;is_admin = true;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;activated = true;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;save();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>完成之后, 重置并填充数据库</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ php artisan migrate:refresh --seed</span></div></div><div><br/></div><div><br/></div><div><br/></div><div>邮件程序</div><div><br/></div><div>接下来的功能开发中, 我们将使用 laravel 来发送邮件, 为了方便测试, 我们需要对环境配置文件 .env 进行配置, 使用 log 邮件驱动的方式来调试邮件发送功能, 这么做的好处是邮件不会真正的发送, 而是会出现在 storage/logs/laravel.log 文件中, 该文件记录一切 laravel 运行时的日志信息, 便于我们在本丢进行测试</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.env</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_DRIVER=log</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div>激活账户</div><div><br/></div><div>激活路由</div><div><br/></div><div>我们需要为用户的激活功能设定好路由, 该路由将附带用户生成的激活 令牌, 在用户点击链接进行激活之后, 我们需要将激活令牌通过路由参数传给控制器的指定动作,  最终生成的激活链接例子如下</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><a href="http://sample.test/signup/confirm/O1TTEr3faVq4fpzFXaOVQD4EAO9mQL" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">http://sample.test/signup/confirm/O1TTEr3faVq4fpzFXaOVQD4EAO9mQL</a></div></div><div><br/></div><div>由上面我们理想中的链接可以推导出应该写的路由为</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('/', 'StaticPagesController@home')-&gt;name('home');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('/help', 'StaticPagesController@help')-&gt;name('help');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('/about', 'StaticPagesController@about')-&gt;name('about');</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('signup', 'UsersController@create')-&gt;name('signup');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::resource('users', 'UsersController');</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('login', 'SessionsController@create')-&gt;name('login');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::post('login', 'SessionsController@store')-&gt;name('login');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::delete('logout', 'SessionsController@destroy')-&gt;name('logout');</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::get('signup/confirm/{token}', 'UsersController@confirmEmail')-&gt;name('confirm_email');</span></div></div><div><br/></div><div>在 laravel 中, 我们使用视图来构建邮件模板, 在用户查收邮件时, 该模板将作为内容展示视图, 接下来我们需要创建一个用于渲染注册邮件的  confirm 视图</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/views/emails/confirm.blade.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;!DOCTYPE html&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;html&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;head&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;title&gt;注册确认链接&lt;/title&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/head&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;body&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;h1&gt;感谢您在 Sample 网站进行注册！&lt;/h1&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    请点击下面的链接完成注册：</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;a href=&quot;{{ route('confirm_email', $user-&gt;activation_token) }}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      {{ route('confirm_email', $user-&gt;activation_token) }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/p&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    如果这不是您本人的操作，请忽略此邮件。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/body&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/html&gt;</span></div></div><div><br/></div><div>登录时检查是否已经激活,</div><div><br/></div><div>在我们前面的章节加入的登录操作中, 用户即使没有激活也能正常登录, 接下来我们需要对之前的登录 代码进行修改, 当用户没有激活的时候, 则视为用户认证失败, 用户将被重定向到首页, 并显示信息提醒引导用户完成邮件查收激活</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/SessionsController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class SessionsController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function store(Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       $credentials = $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'email' =&gt; 'required|email|max:255',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           'password' =&gt; 'required'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       if (Auth::attempt($credentials, $request-&gt;has('remember'))) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           if(Auth::user()-&gt;activated) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               session()-&gt;flash('success', '欢迎回来！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               return redirect()-&gt;intended(route('users.show', [Auth::user()]));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           } else {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               Auth::logout();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               session()-&gt;flash('warning', '你的账号未激活，请检查邮箱中的注册邮件进行激活。');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">               return redirect('/');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       } else {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           session()-&gt;flash('danger', '很抱歉，您的邮箱和密码不匹配');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">           return redirect()-&gt;back();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">       }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>发送邮件</div><div><br/></div><div>接下来我们开始使用邮件发送功能, 在 laravel 中, 可以通过 Mail 接口的 send 方法进行邮件发送. 例如:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$view = 'emails.confirm';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$data = compact('user');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$from = '</span><a href="mailto:aufree@yousails.com" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">aufree@yousails.com</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$name = 'Aufree';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$to = $user-&gt;email;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$subject = &quot;感谢注册 Sample 应用！请确认你的邮箱。&quot;;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Mail::send($view, $data, function ($message) use ($from, $name, $to, $subject) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    $message-&gt;from($from, $name)-&gt;to($to)-&gt;subject($subject);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">});</span></div></div><div><br/></div><div>Mail 的 send 方法接收三个参数:</div><ol><li><div>包含邮件消息的视图名称</div></li><li><div>要传递给该视图的数据数组</div></li><li><div>用来接收邮件消息实例的闭包回调, 我们可以在回调中自定义邮件消息的发送者, 接收者, 邮件主题等等</div></li></ol><div><br/></div><div>接下来让我们为用户控制器定义一个 sendEmailConfrimation 方法, 该方法用于发送邮件给指定用户, 我们会在用户注册成功后调用该方法来发送激活邮件, 具体代码实现如下:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Mail;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function store(Request $request)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;validate($request, [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name' =&gt; 'required|max:50',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'email' =&gt; 'required|email|unique:users|max:255',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'password' =&gt; 'required|confirmed|min:6'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user = User::create([</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name' =&gt; $request-&gt;name,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'email' =&gt; $request-&gt;email,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'password' =&gt; bcrypt($request-&gt;password),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;sendEmailConfirmationTo($user);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        session()-&gt;flash('success', '验证邮件已发送到你的注册邮箱上，请注意查收。');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect('/');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected function sendEmailConfirmationTo($user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $view = 'emails.confirm';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $data = compact('user');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $from = '</span><a href="mailto:aufree@yousails.com" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">aufree@yousails.com</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $name = 'Aufree';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $to = $user-&gt;email;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $subject = &quot;感谢注册 Sample 应用！请确认你的邮箱。&quot;;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Mail::send($view, $data, function ($message) use ($from, $name, $to, $subject) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $message-&gt;from($from, $name)-&gt;to($to)-&gt;subject($subject);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>请注意我们需要调用 use Mail 来引入邮件的相关方法, 通过上面代码我们可以看你到, 我们把之前用户注册成功之后进行的登录操作</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Auth::logout($user);</div></div><div><br/></div><div>替换为激活邮箱的发送操作</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$this-&gt;sendEmailConfrmationTo($user);</div></div><div><br/></div><div>注册成功提示语改为查看邮箱的提示语, 在激活邮件发送成功后, 我们还将用户重定向到首页, 并非之前的个人页面.</div><div><br/></div><div><br/></div><div>激活功能</div><div><br/></div><div>现在的邮箱发送功能已经完成, 接下来让我们完成前面定义的 confrm_email 路由对应的控制器方法 confirmEmail , 来完成用户的激活操作, 并且在 __construct 方法里面启用未登录用户访问权限</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('auth', [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'except' =&gt; ['show', 'create', 'store', 'index', 'confirmEmail']</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function confirmEmail($token)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user = User::where('activation_token', $token)-&gt;firstOrFail();</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;activated = true;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;activation_token = null;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;save();</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Auth::login($user);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        session()-&gt;flash('success', '恭喜你，激活成功！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;route('users.show', [$user]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>Auth 中间件黑名单中, 我们加入了 confirmEmail 来开启登录用户访问权限</div><div><br/></div><div>在 confrimEmail 中, 我们会先根据路由传送过来的 activation_token 参数从数据库中查找对应的用户, Eloquent 的 where 方法接收两个参数, 第一个参数为要进行查找的字段名称, 第二个参数为对应的值, 查询结果返回的就是一个数组, 因此我们需要使用 firstOrFail 方法来取出第一个用户, 在查找不到指定用户的时候返回 404 , 在查找到指用户信息之后, 我们将用户激活状态进行更改, 最后将激活成功的用户进行登录, 在页面上显示相关提示信息</div><div><br/></div><div>如我们尝试注册一个新的用户</div><div><br/></div><div><img src="8.2--账户激活_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>接下来我们便能够在 laravel.log 文件的最后面, 看到相关输出内容</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">storage/logs/laravel.log</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[2017-08-03 04:40:48] local.DEBUG: Message-ID: &lt;</span><a href="mailto:3e1472734effe20355c9cd888d2f47bd@sample.test" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">3e1472734effe20355c9cd888d2f47bd@sample.test</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Date: Thu, 03 Aug 2017 04:40:47 +0000</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Subject: =?utf-8?Q?=E6=84=9F=E8=B0=A2=E6=B3=A8=E5=86=8C?= Sample</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">=?utf-8?Q?=E5=BA=94=E7=94=A8=EF=BC=81=E8=AF=B7?=</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">=?utf-8?Q?=E7=A1=AE=E8=AE=A4=E4=BD=A0=E7=9A=84?=</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">=?utf-8?Q?=E9=82=AE=E7=AE=B1=E3=80=82?=</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">From: Aufree &lt;</span><a href="mailto:aufree@yousails.com" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">aufree@yousails.com</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">To:</span> <a href="mailto:summer2@yousails.com" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">summer2@yousails.com</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MIME-Version: 1.0</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Content-Type: text/html; charset=utf-8</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Content-Transfer-Encoding: quoted-printable</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;!DOCTYPE html&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;html&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;head&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;title&gt;注册确认链接&lt;/title&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/head&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;body&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;h1&gt;感谢您在 Sample 网站进行注册！&lt;/h1&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    请点击下面的链接完成注册：</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;a href=&quot;</span><a href="http://sample.test/signup/confirm/Du6ceeSFg0ok4ZPS4nE5lFwMPWAG2E" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">http://sample.test/signup/confirm/Du6ceeSFg0ok4ZPS4nE5lFwMPWAG2E</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&quot;&gt;</span></div><div><a href="http://sample.test/signup/confirm/Du6ceeSFg0ok4ZPS4nE5lFwMPWAG2E" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">http://sample.test/signup/confirm/Du6ceeSFg0ok4ZPS4nE5lFwMPWAG2E</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/p&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    如果这不是您本人的操作，请忽略此邮件。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/body&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/html&gt;  </span></div></div><div><br/></div><div>上面的主题由于编码格式 UTF-8 解码原因未能正常显示, 通过 log 我们可以判断邮件已经正常发出, 在浏览器上面尝试访问 laravel.log 文件中输出的激活链接, 则可以看到新注册用户被成功激活</div><div><br/></div><div><img src="8.2--账户激活_files/Image [1].png" type="image/png" data-filename="Image.png" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br/></div><div>现在我们完成用户激活功能的开发, 可以对代码进行提交</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ git add -A</div><div>$ git commit -m &quot;Add account activations&quot;</div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 