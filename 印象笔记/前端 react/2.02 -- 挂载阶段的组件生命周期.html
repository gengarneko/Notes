<html>
<head>
  <title>2.02 -- 挂载阶段的组件生命周期</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1305"/>
<h1>2.02 -- 挂载阶段的组件生命周期</h1>

<div>
<span><div><div>我们在 JSX 章节中, 提到如下代码:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ReactDOM.render(</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;Header /&gt;,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  document.getElementById('root')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">)</span></div></div><div><br/></div><div>会编译成</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ReactDOM.render(</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  React.createElement(Header, null),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  document.getElementById('root')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">)</span></div></div><div><br/></div><div>其实我们把 Header 组件传给了 React.createElement 函数, 又把函数返回结果传给了 reactDOM. 我们可以简单猜想一下它们会干什么事情:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// React.createElement 中实例化一个 Header</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">const header = new Header(props, children)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// React.createElement 中调用 header.render 方法渲染组件的内容</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">const headerJsxObject = header.render()</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// ReactDOM 用渲染后的 JavaScript 对象来来构建真正的 DOM 元素</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">const headerDOM = createDOMFromObject(headerJsxObject)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// ReactDOM 把 DOM 元素塞到页面上</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">document.getElementById('root').appendChild(headerDOM)</span></div></div><div><br/></div><div>上面过程其实非常简单, 看代码就能理解.</div><div><br/></div><div>我们把 React.js 将组件渲染, 并且构造 DOM 元素然后塞入页面的过程称为组件的挂载 (这个定义请好好记住). 其实, React.js 内部对待每个组件都有这么一个过程, 也就是初始化组件 -&gt; 挂载到页面上的过程. 所以你可以理解一个组件的方法调用就是这么一个过程:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; constructor()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; render()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 然后构造 DOM 元素插入页面</span></div></div><div><br/></div><div>这当然是很好理解的. React.js 为了让我们能够更好的掌控组件的挂载过程, 往上面插入了两个方法:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; constructor()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; componentWillMount()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; render()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 然后构造 DOM 元素插入页面</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; componentDidMount()</span></div></div><div><br/></div><div>componentWillMount 和 componentDidMount 都是可以像 render 方法一样自定义在组件的内部. 挂载的时候, React.js 会在组件的 render 之前调用 componentWillMount, 在 DOM 元素塞入页面后调用 componentDidMount.</div><div><br/></div><div>我们给 Header 组件加上这两个方法, 并且打一些 Log:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Header extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    console.log('construct')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    console.log('component will mount')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentDidMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    console.log('component did mount')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    console.log('render')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;h1 className='title'&gt;React 小书&lt;/h1&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>在控制台可以看到依次输出:</div><div><br/></div><div><img src="2.02 -- 挂载阶段的组件生命周期_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>可以看到, React.js 确实按照我们上面说的那样调用了定义的两个方法 componentWillMount 和 componentDidMount</div><div><br/></div><div>一个组件可以插入页面, 当然也可以从页面中删除</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; constructor()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; componentWillMount()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; render()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 然后构造 DOM 元素插入页面</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; componentDidMount()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 从页面中删除</span></div></div><div><br/></div><div>React.js 也控制了这个组件的删除过程, 在组件删除之前 React.js 会调用组件定义的 componentWillUnmount:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; constructor()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; componentWillMount()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; render()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 然后构造 DOM 元素插入页面</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; componentDidMount()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 即将从页面中删除</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-&gt; componentWillUnmount()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 从页面中删除</span></div></div><div><br/></div><div>看看什么情况下会把组件从页面中删除, 继续用上面例子的代码, 我们再定义一个 Index 组件:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Index extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor() {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      isShowHeader: true</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleShowOrHide () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      isShowHeader: !this.state.isShowHeader</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {this.state.isShowHeader ? &lt;Header /&gt; : null}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;button onClick={this.handleShowOrHide.bind(this)}&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          显示或者隐藏标题</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ReactDOM.render(</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;Index /&gt;,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  document.getElementById('root')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">)</span></div></div><div><br/></div><div>Index 组件使用了 Header 组件, 并且有一个按钮, 可以控制 Header 的显示或隐藏. 下面这行代码:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...a</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{this.state.isShowHeader ? &lt;Header /&gt; : null}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>相当于 state.isShowOrHide 为 true 的时候把 Header 插入页面, false 的时候把 Header 从页面上删除. 这时候我们给 Header 添加 componentWillUnmount 方法:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillUnmount() {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    console.log('component will unmount')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>这时候点击页面上的按钮, 你会看到页面的标题隐藏了, 并且控制台打印出来下图的最后一行, 说明 componentWillUnmount 确实被 React.js 所调用了:</div><div><br/></div><div><img src="2.02 -- 挂载阶段的组件生命周期_files/Image [1].png" type="image/png" data-filename="Image.png" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br/></div><div>你可以多次点击按钮, 随着按钮的显示和隐藏, 上面的内容会按顺序重复地打印出来,可以体会一下这几个方法的调用过程和顺序.</div><div><br/></div><div><span style="font-weight: bold;">总结</span></div><div><br/></div><div>React.js 将组件渲染, 并且构造 DOM 元素然后塞入页面的过程称为组件的挂载. 现在我们学到了 React.js 控制组件在页面上挂载和删除过程里面几个方法:</div><div><br/></div><ul><li><div>componentWillMount:组件挂载开始之前, 组件调用 render 方法之前</div></li><li><div>componentDidMount: 组件挂载完成后, 也就是 DOM 元素已经插入页面后调用</div></li><li><div>componentWillUnmount: 组件对应的 DOM 元素从页面中删除之后调用 </div></li></ul><div><br/></div><div><br/></div><div>现在我们来讨论一下对于一个组件来说, constructor, componentWillMount, componentDidMount, componentWillUnmount 这几个方法在一个组件的出生到死亡的过程里面起到了什么样的作用.</div><div><br/></div><div>一般来说, 所有关于组件自身的状态的初始化工作都会放在 constructor 里面去做. 你会发现所有组件的 state 的初始化工作都是放在 constructor 里面, 现在我们写一个时钟应用:</div><div><br/></div><div><img src="2.02 -- 挂载阶段的组件生命周期_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>我们会在 constructor 里面初始化 state.date, 当然现在页面还是静态的, 等一下会让页面动起来.</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Clock extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      date: new Date()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;h1&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          &lt;p&gt;现在的时间是&lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          {this.state.date.toLocaleTimeString()}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/h1&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>一些组件启动的动作, 包括像 Ajax 数据的拉取操作, 一些定时器的启动等, 就可以放在 componentWillMount 里面进行, 例如 Ajax:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ajax.get('</span><a href="http://json-api.com/user" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">http://json-api.com/user</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">', (userData) =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      this.setState({ userData })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>当然我们这个例子里面是定时器的启动, 我们给 Clock 启动定时器:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Clock extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      date: new Date()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.timer = setInterval(() =&gt; {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      this.setState({ date: new Date() })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }, 1000)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>我们在 componentWillMount 中用 setInterval 启动了一个定时器: 每个 1s 更新中的 state.date, 这样页面就可以动起来了. 我们用一个 Index 把它用起来, 并且插入页面:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Index extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;Clock /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ReactDOM.render(</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;Index /&gt;,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  document.getElementById('root')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">)</span></div></div><div><br/></div><div>像上一节那样, 我们修改这个 Index 让这个时钟可以隐藏或者显示:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Index extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = { isShowClock: true }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleShowOrHide () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      isShowClock: !this.state.isShowClock</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {this.state.isShowClock ? &lt;Clock /&gt; : null }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;button onClick={this.handleShowOrHide.bind(this)}&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          显示或隐藏时钟</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div></div><div>现在页面上有个按钮可以显示或者隐藏时钟, 你试一下显示或者隐藏时钟, 虽然页面上功能正常, 但是在控制台报错.</div><div><br/></div><div>这是因为, 当时钟隐藏的时候, 我们并没有清除定时器, 时钟隐藏的时候, 定时器的回调函数还在不停地尝试 setState, 由于 setState 只能在已经挂载或者正在挂载的组件上调用, 所以 React.js 开始疯狂报错.</div><div><br/></div><div>多次的隐藏和显示会让 React.js 重新构造和销毁 clock 组件, 每次构造都会重新构建一个定时器, 而销毁组件的时候没有清除定时器, 所以你看到报错会越来越多. 而且因为 JavaScript 的闭包特性, 这样会导致严重的内存泄漏.</div><div><br/></div><div>这时候 componentWillUnmount 就可以派上用场了, 它的作用就是在组件销毁的时候, 做这种清场的工作. 例如清除该组件的定时器和其他的数据清理工作. 我们给 clock 添加 componentWillUnmount, 在组件销毁的时候清除该组件的定时器:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillUnmount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    clearInterval(this.timer)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>这时候就没有错误了</div><div><br/></div><div><b>总结</b></div><div><br/></div><div><br/></div><div>我们一般会把组件的 state 的初始化工作放在 constructor 里面去做; 在 componentWillMount 进行组件的启动工作, 例如 Ajax 数据拉取, 定时器的启动; 组件从页面上销毁的时候, 有时候需要一些数据的清理, 例如定时器的清理, 就会放在 componentWillUnmount 里面去做. </div><div><br/></div><div>说一下我们还没有提及的 componentDidMount. 一般来说, 有些组件的启动工作是依赖 DOM 的, 例如动画的启动, 而 componentWillMount 的时候组件还没挂载完成, 所以没法进行这些启动的工作, 这时候就可以把这些操作放在 componentDidMount 中, 具体使用我们下面讨论.</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 