<html>
<head>
  <title>2.09 -- 实战分析: 评论功能 (五)</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1337"/>
<h1>2.09 -- 实战分析: 评论功能 (五)</h1>

<div>
<span><div>持久化评论</div><div><br/></div><div>同样的, 可以通过类似于用户名持久化的方式对评论列表内容进行持久化, 让用户发布的评论在刷新页面后依然可以存在. 修改 src/CommentApp.js</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class CommentApp extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      comments: []</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this._loadComments()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  _loadComments () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    let comments = localStorage.getItem('comments')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    if (comments) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      comments = JSON.parse(comments)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      this.setState({ comments })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  _saveComments (comments) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    localStorage.setItem('comments', JSON.stringify(comments))</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleSubmitComment (comment) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    if (!comment) return</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    if (!comment.username) return alert('请输入用户名')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    if (!comment.content) return alert('请输入评论内容')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    const comments =</span> <a href="http://this.state.comments/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">this.state.comments</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    comments.push(comment)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({ comments })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this._saveComments(comments)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>我们增加了 _loadComments 和 _saveComments 分别用于加载和保存评论列表数据. 用户每次提交评论都会把评论列表数据保存一次, 所以我们在 handleSubmitComment 调用 _saveComments 方法; 而在 componentWillMount 中调用 _loadComments 方法, 在组件开始挂载的时候把评论列表数据加载出来 setState 到 this.state 中, 组件就可以渲染从 localStorage 中加载出来的评论列表数据了.</div><div><br/></div><div>现在发布评论, 然后刷新可以看到我们的评论并不会像以前一样消失. 非常不错, 持久化评论也完成了.</div><div><b><br/></b></div><div><b>显示评论发布时间</b></div><div><br/></div><div>现在我们给每条评论都加上发布的日期, 并且在评论列表上显示已经发表了多久, 并且 5s 更新一次, 修改 src/CommentInput.js 当用户点击发布按钮的时候, 传出去的评论数据带上评论发布的时间戳:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleSubmit () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    if (this.props.onSubmit) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      this.props.onSubmit({</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        username: this.state.username,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        content: this.state.content,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        createdTime: +new Date()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({ content: '' })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>在评论列表页面上显示评论, 修改 src/comment.js</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Comment extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  static propTypes = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    comment: PropTypes.object.isRequired</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = { timeString: '' }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this._updateTimeString()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  _updateTimeString () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    const comment =</span> <a href="http://this.props.comment/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">this.props.comment</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    const duration = (+Date.now() - comment.createdTime) / 1000</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      timeString: duration &gt; 60</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ? `${Math.round(duration / 60)} 分钟前`</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        : `${Math.round(Math.max(duration, 1))} 秒前`</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div className='comment'&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div className='comment-user'&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          &lt;span&gt;{</span><a href="http://this.props.comment.username/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">this.props.comment.username</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">} &lt;/span&gt;：</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;p&gt;{</span><a href="http://this.props.comment.content/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">this.props.comment.content</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}&lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;span className='comment-createdtime'&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">          {this.state.timeString}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>每个 Comment 组件实例保存一个 timeString 状态, 用于该评论显示发布了多久, _updateTimeString 私有方法会根据 <a href="http://props.comment/">props.comment</a> 里面的 createdTime 来更新这个 timeString: 计算当前时间和评论发布时间的时间差, 如果已经发布 60s 以上就显示分钟, 否则显示秒. 然后 componentWillMount 会在组件挂载阶段调用, _updateTimeString 更新一下这个字符串, render() 方法就把这个显示时间差的字符串渲染到一个 &lt;span&gt; 上.</div><div><br/></div><div>再看看页面:</div><div><img src="2.09 -- 实战分析 评论功能 (五)_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>这时候的时间不会自动更新. 除非你手动刷新页面, 否则永远显示 &quot;1s前&quot;. 我们可以在 componentWillMount 中启动一个定时器, 每个 5s 调用一下 _updateTimeString, 让它去通过 setState 更新 timeString:</div><div><br/></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this._updateTimeString()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this._timer = setInterval(</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      this._updateTimeString.bind(this),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      5000</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><br/></div><div> 这样子做就可以做到评论时间自动刷新了<br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 