<html>
<head>
  <title>3.02 -- React.js 的 context</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1353"/>
<h1>3.02 -- React.js 的 context</h1>

<div>
<span><div>永远用不上的特性 -- context. 过去一直被视为一种不稳定的, 危险的, 可能会被去掉的特性, 但是全世界的第三方库都在使用这个特性</div><div><br/></div><div>除非你觉得自己的 React.js 水平已经炉火纯青了 ,否则永远不都要动 context, 就好像学 JavaScript 时候, 一直被提醒不要用全局变量一样, React.js 的 context 其实就像是组件树上某棵子树的全局变量</div><div><br/></div><div>想象一下我们有这么一课组件树:</div><div><br/></div><div><img src="3.02 -- React.js 的 context_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>假设现在这个组件树代表的应用是用户可以自由换主题色的, 每个子组件会根据主题色的不同调整自己的字体颜色或者背景颜色. &quot;主题色&quot;这个玩意儿是所有组件共享的状态, 根据我们在 前端应用状态管理 -- 状态提升 中所提到的, 需要把这个状态提升到根节点的 Index 上, 然后把这个状态通过 props 一层层传递下去:</div><div><br/></div><div><img src="3.02 -- React.js 的 context_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>假设原来主题色是绿色, 那么 Index 上保存的是 this.state ={themeColor: 'green'}. 如果要改变主题色, 可以直接通过 this.setState({ themeColor: 'red' }) 来进行. 这样整棵组件树就会重新渲染, 子组件也就可以根据重新传进来的 props.themeColor 来调整自己的颜色.</div><div><br/></div><div>但这里的问题也十分明显, 我们需要把 themeColor 这个状态一层层手动地从组建树顶层往下传, 每层都要写 props.themeColor. 如果我们的组件树层次很深的话, 这样维护起来会十分困难.</div><div><br/></div><div>如果这棵组件树能够全局共享这个状态就好了, 我们要的时候就去取这个状态, 不用手动地传:</div><div><br/></div><div><img src="3.02 -- React.js 的 context_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>就像这样, Index 把 state.themeColor 放到某个地方, 这个地方是每个 Index 的子组件都是可以访问到的. 当某个子组件需要的时候就直接去那个地方拿就好了, 而不需要一层层地通过 props 来获取. 不管组件树的层次多深, 任何一个组件都可以直接到这个公共的地方提取 themeColor 状态.</div><div><br/></div><div>React.js 的 context 就是这么一个东西, 某个组件只要往自己的 context 里面放了某些状态, 这个组件之下的所有子组件都直接访问这个状态而不需要通过中间组件的传递.  一个组件的 context 只有它的子组件能够访问, 它的父组件是不能访问的, 你可以理解灭个组件的 context 就是瀑布的源头, 只能往下流不能往上飞.</div><div><br/></div><div>我们看看 React.js 的 context 代码怎么写, 我们先把整体的组件树搭建起来, 这里不涉及 context 相关内容:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Index extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;Header /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;Main /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Header extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;h2&gt;This is header&lt;/h2&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;Title /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Main extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;h2&gt;This is main&lt;/h2&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;Content /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Title extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;h1&gt;React.js 小书标题&lt;/h1&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Content extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;h2&gt;React.js 小书内容&lt;/h2&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ReactDOM.render(</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;Index /&gt;,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  document.getElementById('root')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">)</span></div></div><div><br/></div><div>代码简单, 虽然长了点.</div><div><br/></div><div>现在我们修改 Index, 让它往自己的 context 里面放一个 themeColor</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Index extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  static childContextTypes = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    themeColor: PropTypes.string</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = { themeColor: 'red' }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  getChildContext () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return { themeColor: this.state.themeColor }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;Header /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;Main /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>构造函数里面的内容很好理解, 就是往 state 里面初始化一个 themeColor 状态. getChildContext 这个方法就是设置 context 的过程, 它返回的对象就是 context (也就是上图中处于中间的方块), 所有的子组件都可以访问到这个对象. 我们用 this.state.themeColor 来设置了 context 里面的 themeColor.</div><div><br/></div><div>还有一个看起来很可怕的 childContextTypes, 它的作用其实 propsTypes 验证组件 props 参数的作用类似. 不过它是验证 getChildContext 返回的对象. 为什么要验证 context, 因为 context 是一个危险的特性, 按照 React.js 团队多的想法就是i把危险的事情搞得复杂一些, 提高使用门槛人们就不会去用了. 如果你要给组件设置 context, 那么 childContextTypes 是必写的.</div><div><br/></div><div>现在我们已经完成了 Index 往 context 里面放置状态的工作了, 接下来我们要看看子组件怎么获取这个状态, 修改 Index 的孙子组件 Title:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class Title extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  static contextTypes = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    themeColor: PropTypes.string</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  render () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    return (</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      &lt;h1 style={{ color: this.context.themeColor }}&gt;React.js 小书标题&lt;/h1&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    )</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>子组件要获取 context 里面的内容的话, 就必须写 contextTypes 来声明和验证你需要获取的状态的类型, 它也是必写的, 如果你不写就无法获取 context 里面的状态. Title 想获取 themeColor, 它是一个字符串, 我们就在 contextTypes 里面进行声明.</div><div><br/></div><div>声明以后我们就可以通过 this.context.themeColor 获取到在 Index 放置的值为 red 的 themeColor, 然后设置 h1 的样式, 所以你会看到页面上的字体是红色的</div><div><br/></div><div>如果我们要更改颜色, 只需要在 Index 里面的 setState 就可以了, 子组件会重新渲染, 渲染的时候会重新获取 context 的内容, 例如我们给 Index 调整一下颜色:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.setState({ themeColor: 'green' })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>那么 Title 里面的字体颜色就会显示为绿色. 我们可以如法炮制孙子组件 Context, 或者任意的 Index 下面的子组件. 让它们可以不经过中间 props 的传递就可以获取到 Index 设定的 context 内容.</div><div><br/></div><div>总结</div><div><br/></div><div>一个组件可以通过 getChildContext 方法返回一个对象, 这个对象就是子树的 context, 提供 context 的组件必须提供 childContextTypes 作为 context 的声明和验证.</div><div><br/></div><div>如果一个组件设置了 context, 那么它的子组件都可以直接访问到里面的内容, 它就像这个组件为根的子树的全局变量. 任意深度的子组件都可以通过 contextTypes 来声明想要的 context 里面的哪些状态, 然后可以通过 this.context 访问到那些状态.</div><div><br/></div><div>context 打破了组件和组件之间通过 props 传递数据的规范, 极大地增强了组件之间的耦合性. 而且, 就如全局变量yiyang,1context 里面的数据能被随意接触就能被随修改, 每个组件都能够改 context 里面的内容会导致程序的运行不可预料.</div><div><br/></div><div>但是这种机制对于前端应用状态管理来说是很有帮助的, 因为毕竟很多状态都会在组件之间进行共享, context 会给我们带来很大的方便. 一些第三方的前端应用状态管理的库 (如 Redux) 就是充分利用这种机制给我们提供便利的状态管理服务. 但我们一般不需要手动写 context, 也不要用它, 只需要用好这些第三方的应用状态管理库就行了.</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 