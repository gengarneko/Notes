<html>
<head>
  <title>2.08 -- 实战分析: 评论功能 (四)</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1331"/>
<h1>2.08 -- 实战分析: 评论功能 (四)</h1>

<div>
<span><div><div>目前为止, 第二阶段知识已经介绍完毕, 我们已经具备项目上手必备的 React.js 知识, 现在可以去应用了.</div><div><br/></div><div>我们在上一阶段的评论功能基础上加上以下需求:</div><div><br/></div><ol><li><div>页面加载完成自动聚焦到评论输入框</div></li><li><div>把用户名持久化, 存放在浏览器的 LocalStorage 中. 页面加载时会把用户名加载出来显示到输入框, 用户就不需要重新输入用户名了.</div></li><li><div>把已经发布的评论持久化, 存放到浏览器的 LocalStorage 中, 页面加载时会把已经保存的评论加载出来, 显示到页面的评论上.</div></li><li><div>评论显示发布日期, 如 &quot;1s前&quot;, 并且会每隔 5s 更新发布日期.</div></li><li><div>评论可以被删除</div></li><li><div>类似 Markdown 的行内代码块显示功能, 用户输入的用 `` 包含起来的内容都会被处理成 &lt;code&gt; 元素包含. </div></li></ol><div><img src="2.08 -- 实战分析 评论功能 (四)_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div>自动聚焦到评论框</div><div><br/></div><div>这个功能十分简单, 我们需要获取 textarea 的 DOM 元素然后调用 focus() API 就可以了. 我们给输入框元素加上 ref 以便获取得到 DOM 元素, 修改 src/CommentInput.js 文件:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;textarea</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      ref={(textarea) =&gt; this.textarea = textarea}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      value={this.state.content}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      onChange={this.handleContentChange.bind(this)} /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>组件挂载完成以后就可以调用 this.textarea.focus(), 给 CommentInput 组件加上 ComponentDidMount 生命周期:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class CommentInput extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  static propTypes = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    onSubmit: PropTypes.func</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      username: '',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      content: ''</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentDidMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.textarea.focus()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>这个功能就完成了, 现在体验还不是很好, 接下来我们把用户名持久化一下, 体验就会很好.</div><div><br/></div><div>大家可以注意到我们给原来的 props.onSubmit 参数加了组件参数验证, 我们会给评论功能的组件加上 propsTypes 进行参数验证.</div><div><b><br/></b></div><div><b>持久化用户名</b></div><div><br/></div><div>用户输入用户名, 然后我们把用户名保存到浏览器的 LocalStorage 当中, 当页面加载的时候再从 LocalStorage 把之前保存的用户名显示到用户名输入框当中. 这样用户就不用每次都输入用户名了, 并且评论框是自动聚焦的, 用户的输入体验会好很多.</div><div><br/></div><div>我们监听用户名输入框失去焦点的事件 onBlur:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;input</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      value={this.state.username}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      onBlur={this.handleUsernameBlur.bind(this)}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      onChange={this.handleUsernameChange.bind(this)} /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>在 handleUsernameBlur 中我们把用户的输入内容保存到 LocalStorage 当中:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class CommentInput extends Component {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  constructor () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    super()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.state = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      username: '',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      content: ''</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentDidMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this.textarea.focus()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  _saveUsername (username) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    localStorage.setItem('username', username)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  handleUsernameBlur (event) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this._saveUsername(event.target.value)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>在 handleusernameBlur 中我们把用户输入的内容传给了 _saveUsername 私有方法 (所有私有方法都是 _ 开头). _saveUsername 会设置 LocalStorage 中的 username 字段, 用户名就持久化了. 这样就相当于每当用户输入完用户名后 (输入框失去焦点的时候), 都会把用户名自动保存一次.</div><div><br/></div><div>输入用户名, 然后浏览器里面看看是否保存了</div><div><br/></div><div><img src="2.08 -- 实战分析 评论功能 (四)_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>然后我们组建挂载的时候把用户名加载起来. 这是一种数据加载操作, 我们说过, 不依赖 DOM 操作的组件启动的操作都可以放在 componentWillMount 中进行, 所以给 CommentInput 添加 componentWillMount 的组件生命周期:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  componentWillMount () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    this._loadUsername()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  _loadUsername () {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    const username = localStorage.getItem('username')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    if (username) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      this.setState({ username })</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  _saveUsername (username) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    localStorage.setItem('username', username)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">...</span></div></div><div><br/></div><div>componentWillMount 会调用 _localUsername 私有方法, _loadUsername 会从 LocalStorage 加载用户名并且 setState 到组件的 state.username 中. 那么组件在渲染的时候 (render 方法) 挂载的时候就可以用上用户名了.</div><div><br/></div><div>这样体验就好多了, 刷新页面, 不需要输入用户名, 并且自动聚焦到输入框. </div><div><b><br/></b></div><div><b>小贴士</b></div><div><br/></div><div>这里插入一些小贴士, 大家可以注意到我们的组件的命名方式和方法的摆放顺序其实有一定的讲究, 这里简单分享一下个人习惯, 仅供参考.</div><div><br/></div><div>组件的私有方法都用 _ 开头, 所有时间箭筒方法都用 handle 开头. 把事件监听方法传给组件的时候, 属性名用 on 开头, 例如:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;CommentInput </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span>    </span>onSubmit={this.handleSubmitComment.bind(this)} /&gt;</span></div></div><div><br/></div><div>这样统一规范处理事件命名会给我们带来语义化组件的好处, 监听 (on) CommentInput 的 Submit 事件, 并且交给 this 去处理 (handle). 这种规范在多人协作的时候也会方便很多.</div><div><br/></div><div>另外, 组件的内容编写顺序如下:</div><ol><li><div>static 开头的类属性, 如 defaultProps, propTypes.</div></li><li><div>构造函数, constructor.</div></li><li><div>getter/setter (还不了解的可以暂时忽略).</div></li><li><div>组件生命周期.</div></li><li><div>_ 开头的私有方法.</div></li><li><div>事件监听方法, handle.</div></li><li><div>render* 开头的方法, 有时候 render() 方法里面的内容会分开到不同函数里面执行.</div></li><li><div>render() 方法.</div></li></ol><div><br/></div><div>如果所有组件都是按照这种顺序来写, 那么维护起来就会方便很多, 多人协作的时候别人理解代码也会一目了然.</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 