<html>
<head>
  <title>3.03 -- Redux 1 -  优雅地修改共享状态</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1361"/>
<h1>3.03 -- Redux 1 -  优雅地修改共享状态</h1>

<div>
<span><div>本节起我们开始学 Redux, 一中新的前端 &quot;架构模式&quot;. 经常和 React.js 一并提出, 你要用 React.js 基本都要伴随着 Redux 和 React.js 结合的库 React-redux.</div><div><br/></div><div>要注意的是, Redux 和 React-redux 并不是同一种东西. Redux 是一种架构模式 (Flux 架构的一种变种), 它不关注你到底用什么库, 你可以把它应用到 React 和 Vue, 甚至跟 jQuery 结合起来都没问题. 而 React-redux 就是把 Redux 这种架构模式和 React.js 结合起来的一个库, 就是 Redux 架构在 React.js 中的体现.</div><div><br/></div><div>如果把 Redux 的用法重新介绍一遍那么本书的价值就不大了, 我大可以把官网的 Reducers, Actions, Store 的用法, API, 关系重复一遍. 现在让我们忘掉 React.js + Redux, 从一个例子的代码 + 问题开始:</div><div><br/></div><div>用 create-react-app 新建一个项目 make-redux, 修改 public/index.html 里面的 body 结构为:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;body&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div id='title'&gt;&lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div id='content'&gt;&lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  &lt;/body&gt;</span></div></div><div><br/></div><div>删除 src/index.js 里面所有的代码, 添加下面代码, 代表我们应用的状态:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">const appState = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  title: {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    text: 'React.js 小书',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    color: 'red',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  content: {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    text: 'React.js 小书内容',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    color: 'blue'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>我们新增几个渲染函数, 它会把上面状态的数据渲染到页面上:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function renderApp (appState) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  renderTitle(appState.title)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  renderContent(appState.content)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function renderTitle (title) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  const titleDOM = document.getElementById('title')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  titleDOM.innerHTML = title.text</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  titleDOM.style.color = title.color</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function renderContent (content) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  const contentDOM = document.getElementById('content')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  contentDOM.innerHTML = content.text</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  contentDOM.style.color = content.color</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>很简单, renderApp 会调用 renderTitle 和 renderContent, 而这两者会把 appState 里面的数据通过原始的 DOM 操作更新到页面上, 调用:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">renderApp(appState)</span></div></div><div><br/></div><div>会在页面上显示</div><div><br/></div><div>这是一个很简单的 App, 但是它存在一个重大的隐患, 我们渲染数据的时候, 使用的是一个共享状态 appState, 每个人都可以修改它. 如果我在渲染之前做了一系列其他操作:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">loadDataFromServer()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">doSomethingUnexpected()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">doSomthingMore()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">renderApp(appState)</span></div></div><div><br/></div><div>renderApp(appState) 之前执行了一大堆函数操作, 你根本不知道它们会对 appState 做什么事情, renderApp(appState) 的结果根本没法得到保障. 一个可以被不同模块任意修改共享的数据状态就是魔鬼, 一旦数据可以任意修改, 所有对共享状态的操作都是不可预料的 (某个模块 appState.title = null 你一点意见都没有), 出现问题的时候 debug 起来就非常困难, 这就是来生常谈的尽量避免全局变量.</div><div><br/></div><div>你可能会说我去看一下函数就知道实现了什么修改了什么, 在我们这个例子还是很简单的, 但是真实的项目当中的函数调用和数据初始化操作非常复杂, 深层次的函数调用修改了状态是很难调试的.</div><div><br/></div><div>但不同的模块(组件)之间确实需要共向数据, 这些模块(组件)还可能需要修改这些共享数据, 就像上一节的 &quot;主题色&quot; 状态 (themeColor). 这里的矛盾就是: &quot;模块(组件之间需要共享数据)&quot;, 和 &quot;数据可能被任意修改导致不可预料的结果&quot; 之间的矛盾.</div><div><br/></div><div>让我们来想办法解决这个问题, 我们可以学习 React.js 团队的做法, 把事情搞得复杂一些, 提高数据修改的门槛: 模块 (组件) 之间可以共享数据, 也可以改数据. 但是我们约定, 这个数据并不能直接修改, 你只能执行某些我允许的某些修改, 而且你修改的必须大张旗鼓地告诉我.</div><div><br/></div><div>我们定义一个函数, 叫 dispatch, 它专门负责数据的修改:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function dispatch (action) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  switch (action.type) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    case 'UPDATE_TITLE_TEXT':</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      appState.title.text = action.text</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      break</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    case 'UPDATE_TITLE_COLOR':</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      appState.title.color = action.color</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      break</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    default:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      break</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>所有对数据的操作必须通过 dispatch 函数, 它接受一个参数 action, 这个 action 是一个普通的 JavaScript 对象, 里面必须包含一个 type 字段来声明你到底想干什么. dispatch 在 switch 里面会识别这个 type 字段, 能够识别出来的操作才会执行对 appState 的修改.</div><div><br/></div><div>上面的 dispatch 它只能识别两种操作, 一种是 UPDATE_TITLE_TEXT 它会用 action 的 text 字段去更新 appState.title.text; 一种是 UPDATE_TITLE_COLOR. 它会用 action 的 color 字段去更新 appState.title.color. 可以看到, action 里面除了 type 字段是必须的以外, 其他字段都是可以自定义的.</div><div><br/></div><div>任何的模块如果想要修改 appState.title.text, 必须大张旗鼓地调用 dispatch:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">dispatch({ type: 'UPDATE_TITLE_TEXT', text: '《React.js 小书》' }) // 修改标题文本</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">dispatch({ type: 'UPDATE_TITLE_COLOR', color: 'blue' }) // 修改标题颜色</span></div></div><div><br/></div><div>我们来看看有什么好处:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">loadDataFromServer() // =&gt; 里面可能通过 dispatch 修改标题文本</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">doSomethingUnexpected()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">doSomthingMore() // =&gt; 里面可能通过 dispatch 修改标题颜色</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">renderApp(appState)</span></div></div><div><br/></div><div>我们不需要担心 renderApp(appState) 之前的那堆函数操作会干什么奇怪的事情, 因为我们规定不能直接修改 appState, 它们对 appState 的修改必须只能通过 dipatch. 而我们看看 dispatch 的实现可以知道, 你只能修改 title.text 和 title.color.</div><div><br/></div><div>如果某个函数修改了 title.text, 但是我并不想要它这么干, 我需要 debug 出来是哪个函数修改了, 我只需要在 dispatch 的 switch 的第一个 case 内部打个断点就调试出来了.</div><div><br/></div><div>原来模块 (组件) 修改共享数据是直接改的:</div><div><br/></div><div><img src="3.03 -- Redux 1 -  优雅地修改共享状态_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>我们很难把控每一根指向 appState 的箭头, appState 里面的东西就无法把控. 但现在我们必须通过一个 &quot;中间人&quot; -- dispatch, 所有的数据修改必须通过它, 并且你必须用 action 来大声告诉它要修改什么, 只有它允许的才能修改:</div><div><br/></div><div><img src="3.03 -- Redux 1 -  优雅地修改共享状态_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>我们再也不用担心共享数据状态的修改的问题了, 我们只把控了 dispatch, 所有的对 appState 的修改就无所遁形, 毕竟只有一根箭头指向 appState 了.</div><div><br/></div><div>本节完整代码如下:</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">let appState = {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  title: {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    text: 'React.js 小书',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    color: 'red',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  },</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  content: {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    text: 'React.js 小书内容',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    color: 'blue'</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function dispatch (action) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  switch (action.type) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    case 'UPDATE_TITLE_TEXT':</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      appState.title.text = action.text</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      break</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    case 'UPDATE_TITLE_COLOR':</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      appState.title.color = action.color</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      break</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    default:</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">      break</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function renderApp (appState) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  renderTitle(appState.title)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  renderContent(appState.content)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function renderTitle (title) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  const titleDOM = document.getElementById('title')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  titleDOM.innerHTML = title.text</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  titleDOM.style.color = title.color</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">function renderContent (content) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  const contentDOM = document.getElementById('content')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  contentDOM.innerHTML = content.text</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">  contentDOM.style.color = content.color</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">renderApp(appState) // 首次渲染页面</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">dispatch({ type: 'UPDATE_TITLE_TEXT', text: '《React.js 小书》' }) // 修改标题文本</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">dispatch({ type: 'UPDATE_TITLE_COLOR', color: 'blue' }) // 修改标题颜色</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">renderApp(appState) // 把新的数据渲染到页面上</span></div></div><div> </div><div>下一节我们会把这种 dispatch 模式抽离出来, 让它变得更通用.</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 