<html>
<head>
  <title>2.3 -- 个人页面</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1777"/>
<h1>2.3 -- 个人页面</h1>

<div>
<span><div><div><span style="font-weight: bold;">功能说明</span></div><div><br/></div><div>接下来创建各个人页面, 用作用户个人信息展示, 可以在其中看到用户发表的文章以及报修信息</div><div><br/></div><div><span style="font-weight: bold;">修改模型文件存放的位置</span></div><div><br/></div><div>laravel 为我们生成了用户模型文件 ap/User.php 默认情况下, 我们在 app 文件夹下面新建一个 models 文件夹</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ mkdir app/Models</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ mv app/User.php app/Models/User.php</span></div></div><div><br/></div><div>1.修改 User.php 文件, 更改 namespace 为我们新建的文件夹路径</div><div><br/></div><div>app/Models/User.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Models;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div>2.全局搜索 App\User 替换为 App\Models\User</div><div><br/></div><div>改动较大, 我们进行一次 git 提交</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git add -A</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git commit -m &quot;Move user model to models folder&quot;</span></div></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">设置路由</span></div><div><br/></div><div>我们使用 资源控制器 功能, 接下来我们先给控制器注册一个资源路由</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// Route::get('/users/{user}', 'UsersController@show')-&gt;name('users.show');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// Route::get('/users/{user}/edit', 'UsersController@edit')-&gt;name('users.edit');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// Route::patch('/users/{user}', 'UsersController@update')-&gt;name('users.update');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 等同于下面一行</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">Route::resource('users', 'UsersController', ['only' =&gt; ['show', 'update', 'edit']]);</span></div><div><br/></div></div><div><br/></div><div>可以看到使用 resource 方法不仅节省很多代码，且严格遵循了 RESTful URI 的规范，在后续的开发中，我们会优先选择 resource 路由。</div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">创建控制器</span></div><div><br/></div><div>接下来我们需要创建一个 UsersController 控制器，这个控制器将负责用户相关的页面和逻辑处理。Laravel 的控制器命名规范统一使用驼峰式大小写和复数形式来命名，在这里我们也应该这么做。一般情况下，我们会使用下面命令来生成控制器：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ php artisan make:controller UsersController</span></div></div><div><br/></div><div>然后我们对用户控制器进行编辑</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Http\Request;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\User;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function show(User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('users.show', compact('user'));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><ol><li><div>第一个修改是引入了 App\Models\User 用户模型，因为将要在 show() 方法中使用到 User 模型，所以我们必须先引用。</div></li></ol><div><br/></div><ol start="2"><li><div>接下来我们看下 show() 方法的声明：</div></li></ol><div><br/></div><div>Laravel 会自动解析定义在控制器方法（变量名匹配路由片段）中的 Eloquent 模型类型声明。在上面代码中，由于 show() 方法传参时声明了类型 —— Eloquent 模型 User，对应的变量名 $user 会匹配路由片段中的 {user}，这样，Laravel 会自动注入与请求 URI 中传入的 ID 对应的用户模型实例。</div><div><br/></div><div>此功能称为 『隐性路由模型绑定』，是『约定优于配置』设计范式的体现，同时满足以下两种情况，此功能即会自动启用：</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">创建视图</span></div><div><br/></div><div>下面让我们来创建用户个人页面视图</div><div><br/></div><div>show.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@extends('layouts.app')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@section('title', $user-&gt;name . ' 的个人中心')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@section('content')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;div class=&quot;row&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;col-lg-3 col-md-3 hidden-sm hidden-xs user-info&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;panel panel-default&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;div class=&quot;panel-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;media&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;div align=&quot;center&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;img class=&quot;thumbnail img-responsive&quot; src=&quot;</span><a href="https://fsdhubcdn.phphub.org/uploads/images/201709/20/1/PtDKbASVcz.png?imageView2/1/w/600/h/600" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">https://fsdhubcdn.phphub.org/uploads/images/201709/20/1/PtDKbASVcz.png?imageView2/1/w/600/h/600</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&quot; width=&quot;300px&quot; height=&quot;300px&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;div class=&quot;media-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;hr&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;h4&gt;&lt;strong&gt;个人简介&lt;/strong&gt;&lt;/h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;p&gt;Lorem ipsum dolor sit amet, consectetur adipiscing elit. &lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;hr&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;h4&gt;&lt;strong&gt;注册于&lt;/strong&gt;&lt;/h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;p&gt;January 01 1901&lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;col-lg-9 col-md-9 col-sm-12 col-xs-12&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;panel panel-default&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;div class=&quot;panel-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;h1 class=&quot;panel-title pull-left&quot; style=&quot;font-size:30px;&quot;&gt;{{ $user-&gt;name }} &lt;small&gt;{{ $user-&gt;email }}&lt;/small&gt;&lt;/h1&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;hr&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {{-- 用户发布的内容 --}}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;panel panel-default&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;div class=&quot;panel-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                暂无数据 ~_~</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@stop</span></div></div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">Git 版本控制</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git add -A</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git commit -m &quot;User profile page&quot;</span></div></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">编辑个人资料</span></div><div><br/></div><div><span style="font-weight: bold;">新增字段</span></div><div><br/></div><div>查看迁移文件 database/migrations/2014_10_12_000000_create_users_table.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function up()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Schema::create('users', function (Blueprint $table) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;increments('id');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;string('name');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;string('email')-&gt;unique();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;string('password');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;rememberToken();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;timestamps();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div> </div><div>可以看到我们还缺 头像 和 个人简介 字段</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">php artisan make:migration add_avatar_and_introduction_to_users_table --table=users</span></div></div><div><br/></div><div>我们会将头像的图片以文件形式放置于服务器上，然后将路径子串存储于数据库中，所以我们需要用到 string 类型，用户注册并未提供头像上传功能，因此我们还需要将字段设置为 nullable，意为允许空子串。</div><div>个人简介字段存储的是短文本内容，此处我们也选择使用 string 类型，同样的我们也允许用户设置空的简介。现在让我们来为新增的迁移文件加上这两个字段：</div><div><br/></div><div>database/migrations/[timestamp]_add_avatar_and_introduction_to_users_table.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Support\Facades\Schema;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Schema\Blueprint;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Database\Migrations\Migration;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class AddAvatarAndIntroductionToUsersTable extends Migration</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * 执行迁移</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return void</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function up()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Schema::table('users', function (Blueprint $table) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;string('avatar')-&gt;nullable();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;string('introduction')-&gt;nullable();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * 回滚迁移</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return void</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function down()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Schema::table('users', function (Blueprint $table) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;dropColumn('avatar');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $table-&gt;dropColumn('introduction');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>接着我们还需要运行迁移，将字段加入到用户表中：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ php artisan migrate</span></div></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">增加入口</span></div><div><br/></div><div>接下来我们需要增加一个页面链接入口，让登录用户可以很方便地进入到自己的『资料编辑页面』：</div><div><br/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;a href=&quot;{{ route('users.edit', Auth::id()) }}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    编辑资料</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/li&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;a href=&quot;{{ route('logout') }}&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    onclick=&quot;event.preventDefault();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                             document.getElementById('logout-form').submit();&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    退出登录</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/a&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;form id=&quot;logout-form&quot; action=&quot;{{ route('logout') }}&quot; method=&quot;POST&quot; style=&quot;display: none;&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    {{ csrf_field() }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/form&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/ul&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        .</span></div></div><div><br/></div><div>我们需要前往 UsersController 控制器里创建 edit() 方法：</div><div><br/></div><div>app/Http/Controllers/UsersController.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Http\Request;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\User;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function show(User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('users.show', compact('user'));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function edit(User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('users.edit', compact('user'));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div>edit() 方法接受 $user 用户作为传参，也就是说当 URL 是 http://larabbs.test/users/1/edit 时，读取的是 ID 为 1 的用户。这里使用的是与 show() 方法一致的 『隐性路由模型绑定』 开发范式。</div><div>view() 方法加载了 resources/views/users/edit.blade.php 模板，并将用户实例作为变量传置于模板中。</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">页面模板</span></div><div><br/></div><div>resources/views/users/edit.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@extends('layouts.app')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@section('content')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;div class=&quot;container&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;panel panel-default col-md-10 col-md-offset-1&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;panel-heading&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;i class=&quot;glyphicon glyphicon-edit&quot;&gt;&lt;/i&gt; 编辑个人资料</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;panel-body&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;form action=&quot;{{ route('users.update', $user-&gt;id) }}&quot; method=&quot;POST&quot; accept-charset=&quot;UTF-8&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;input type=&quot;hidden&quot; name=&quot;_method&quot; value=&quot;PUT&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;input type=&quot;hidden&quot; name=&quot;_token&quot; value=&quot;{{ csrf_token() }}&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;label for=&quot;name-field&quot;&gt;用户名&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;input class=&quot;form-control&quot; type=&quot;text&quot; name=&quot;name&quot; id=&quot;name-field&quot; value=&quot;{{ old('name', $user-&gt;name) }}&quot; /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;label for=&quot;email-field&quot;&gt;邮 箱&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;input class=&quot;form-control&quot; type=&quot;text&quot; name=&quot;email&quot; id=&quot;email-field&quot; value=&quot;{{ old('email', $user-&gt;email) }}&quot; /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;label for=&quot;introduction-field&quot;&gt;个人简介&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;textarea name=&quot;introduction&quot; id=&quot;introduction-field&quot; class=&quot;form-control&quot; rows=&quot;3&quot;&gt;{{ old('introduction', $user-&gt;introduction) }}&lt;/textarea&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;well well-sm&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;保存&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/form&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/div&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@endsection</span></div></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">更新用户信息</span></div><div><br/></div><div>]在编辑页面的 个人简介 框里随便填写内容，然后点击『保存』按钮，会出现 update 不存在</div><div><br/></div><div>app/Http/Controllers/UsersController.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Http\Requests\UserRequest;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function update(UserRequest $request, User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;update($request-&gt;all());</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;route('users.show', $user-&gt;id)-&gt;with('success', '个人资料更新成功！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">表单请求 UserRequest</span></div><div><br/></div><div>表单请求验证（FormRequest） 是 Laravel 框架提供的用户表单数据验证方案，此方案相比手工调用 validator 来说，能处理更为复杂的验证逻辑，更加适用于大型程序。在本课程中，我们将统一使用 表单请求验证来处理表单验证逻辑。</div><div><br/></div><div>接下来我们创建 UserRequest ，使用以下命令：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ php artisan make:request UserRequest</span></div></div><div><br/></div><div>app/Http/Requests/UserRequest.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Requests;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Foundation\Http\FormRequest;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UserRequest extends FormRequest</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function authorize()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return false;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function rules()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            //</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div>接下来我们需要定制 rules() 方法，如下：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Requests;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Foundation\Http\FormRequest;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Auth;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UserRequest extends FormRequest</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function authorize()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return true;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function rules()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name' =&gt; 'required|between:3,25|regex:/^[A-Za-z0-9\-\_]+$/|unique:users,name,' . Auth::id(),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'email' =&gt; 'required|email',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'introduction' =&gt; 'max:80',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>rules() 方法内，对三个字段设置了不同的验证规则，下面分别讲解下：</div><div>* name.required —— 验证的字段必须存在于输入数据中，而不是空。详见文档</div><div>* name.between —— 验证的字段的大小必须在给定的 min 和 max 之间。详见文档</div><div>* name.regex —— 验证的字段必须与给定的正则表达式匹配。详见文档</div><div>* name.unique —— 验证的字段在给定的数据库表中必须是唯一的。详见文档</div><div>* email.required —— 同上</div><div>* email.email —— 验证的字段必须符合 e-mail 地址格式。详见文档</div><div>* introduction.max —— 验证中的字段必须小于或等于 value。详见文档</div><div><br/></div><div><br/></div><div>接下来测试下，在用户名那输入一个字符串，然后点击保存：</div><div><br/></div><div>页面刷新了，不过什么都没发生，其实这是因为 UserRequest 验证不通过，带着错误提示跳转回来了，不过因为我们未对错误提示进行处理，所以什么都没发生。接下来我们创建 error.blade.php 文件来渲染错误提示：</div><div><br/></div><div>resources/views/common/error.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@if (count($errors) &gt; 0)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;alert alert-danger&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;h4&gt;有错误发生：&lt;/h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;ul&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            @foreach ($errors-&gt;all() as $error)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li&gt;&lt;i class=&quot;glyphicon glyphicon-remove&quot;&gt;&lt;/i&gt; {{ $error }}&lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            @endforeach</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/ul&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@endif</span></div></div><div><br/></div><div><br/></div><div>并在表单中加载（只添加一行 @include('common.error') ）：</div><div>resources/views/users/edit.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;panel-heading&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;i class=&quot;glyphicon glyphicon-edit&quot;&gt;&lt;/i&gt; 编辑个人资料</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        @include('common.error')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;panel-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div><br/></div><div>我们能成功看到未通过验证的错误信息，可英文提示并不友好。Laravel 为验证消息支持多语言方案，我们可以通过添加一个如 resources/lang/xx/validation.php 语言包，并在语言包的 custom 数组中对翻译语言进行设定即可：</div><div><br/></div><div>这是非常通用的功能，GitHub 上有开发者专门为此写了一个扩展包 - overtrue/laravel-lang 来对 Laravel 提供默认提示信息添加多语言版本翻译。</div><div><br/></div><div>接下来让我们使用 Composer 来安装 laravel-lang。</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ composer require &quot;overtrue/laravel-lang:~3.0&quot;</span></div></div><div><br/></div><div><br/></div><div>我们需要自定义表单的提示信息，修改 UserRequest，新增方法 messages()：</div><div><br/></div><div>app/Http/Requests/UserRequest.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function messages()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name.unique' =&gt; '用户名已被占用，请重新填写',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name.regex' =&gt; '用户名只支持英文、数字、横杠和下划线。',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name.between' =&gt; '用户名必须介于 3 - 25 个字符之间。',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name.required' =&gt; '用户名不能为空。',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>messages() 方法是 表单请求验证（FormRequest）一个很方便的功能，允许我们自定义具体的消息提醒内容，键值的命名规范 —— 字段名 + 规则名称，对应的是消息提醒的内容。效果如下：</div><div><img src="2.3 -- 个人页面_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>再次测试下编辑资料功能，请在『个人简介』里填入一些信息，点击保存按钮：</div><div><br/></div><div>这一次没有报错信息，缺少提示信息让我们无法很直观地判断到底是否成功，UsersController 里的 update() 方法：</div><div><br/></div><div>如果表单验证通过，就更新内容，最后跳转到个人页面，并附带成功的消息提醒，接下来我们要做的，就是渲染这个提醒。</div><div><br/></div><div>先创建 _message.blade.php 文件：</div><div>resources/views/layouts/_message.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@if (Session::has('message'))</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;alert alert-info&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;alert&quot; aria-hidden=&quot;true&quot;&gt;×&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {{ Session::get('message') }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@endif</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@if (Session::has('success'))</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;alert alert-success&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;alert&quot; aria-hidden=&quot;true&quot;&gt;×&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {{ Session::get('success') }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@endif</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@if (Session::has('danger'))</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;alert alert-danger&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;alert&quot; aria-hidden=&quot;true&quot;&gt;×&lt;/button&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        {{ Session::get('danger') }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@endif</span></div></div><div><br/></div><div>操作提示在项目的其他地方也会用到，因此我们在主要布局模板中加载（只需添加一行代码 @include('layouts._message') ）：</div><div>resources/views/layouts/app.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;container&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            @include('layouts._message')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            @yield('content')</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        @include('layouts._footer')</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div>进行测试 如下:</div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">内容嵌套</span></div><div><br/></div><div>刚刚更新了个人简介，接下来我们将在个人中心里显示出来：</div><div><br/></div><div>resources/views/users/show.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;div class=&quot;media-body&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;hr&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;h4&gt;&lt;strong&gt;个人简介&lt;/strong&gt;&lt;/h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;p&gt;{{ $user-&gt;introduction }}&lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;hr&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;h4&gt;&lt;strong&gt;注册于&lt;/strong&gt;&lt;/h4&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;p&gt;{{ $user-&gt;created_at-&gt;diffForHumans() }}&lt;/p&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div>页面中有两个问题：</div><div>1. 个人简介为空；</div><div>2. 7 hours ago 英文输出。</div><div><br/></div><div><span style="font-weight: bold;">1. 个人简介为空</span></div><div><br/></div><div>个人简介居然为空，我们明明在最后一次测试中填入内容了，并且也显示成功更新。让我们用数据库工具瞧一瞧是否有内容：</div><div>居然是空的，所以很明显，刚刚数据并没有更新成功。</div><div>经过一番调试以后，原来是因为我们没有在 User.php 模型文件中，将 introduction 字段添加至 $fillable 属性中。$fillable 属性的作用是防止用户随意修改模型数据，只有在此属性里定义的字段，才允许修改，否则忽略。我们只需请按下图新增字段即可：</div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>成功显示</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">2. 中文显示友好时间戳</span></div><div><br style="font-weight: bold;"/></div><div>在 Laravel 中，时间戳 created_at 和 updated_at 作为模型属性被调用时，都会自动转换为 Carbon 对象，下图我们使用 Laravel 自带的 dd() 辅助函数验证一下：</div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>Carbon 是 PHP 知名的 DateTime 操作扩展，Laravel 将其默认集成到了框架中。diffForHumans 是 Carbon 对象提供的方法，默认情况是英文的，如果要使用中文时间提示，则需要对 Carbon 进行本地化设置。对 Carbon 进行本地化的设置很简单，只在 AppServiceProvider 中调用 Carbon 的 setLocale 方法即可，AppServiceProvider 是框架的核心，在 Laravel 启动时，会最先加载该文件。</div><div><br/></div><div>app/Providers/AppServiceProvider.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function boot()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        //</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        \Carbon\Carbon::setLocale('zh');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">Git 版本控制</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git add -A</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git commit -m &quot;Basic user profile editing&quot;</span></div></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">上传头像</span></div><div><br/></div><div>目前为止，图中的这两张图都是测试图片，接下来我们将一起开发个人资料里的头像上传功能，并将这两张图片换为用户上传的头像<span style="font-weight: bold;">。</span></div><div><br/></div><div><span style="font-weight: bold;">模型文件修改</span></div><div><br/></div><div>首先我们需在 User 模型里将 avatar 字段加入到允许修改的白名单 $fillable 中：</div><div><br/></div><div><span style="font-size: 12px;"><span style="color: rgb(51, 51, 51); font-family: Monaco; font-size: 12px; font-weight: bold;">编辑页面</span></span></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">接下来我们在 资料编辑页面 的『个人简介』编辑框下面，增加头像上传的选项：</span></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">resources/views/users/edit.blade.php</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;label for=&quot;introduction-field&quot;&gt;个人简介&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;textarea name=&quot;introduction&quot; id=&quot;introduction-field&quot; class=&quot;form-control&quot; rows=&quot;3&quot;&gt;{{ old('introduction', $user-&gt;introduction ) }}&lt;/textarea&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;div class=&quot;form-group&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;label for=&quot;&quot; class=&quot;avatar-label&quot;&gt;用户头像&lt;/label&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;input type=&quot;file&quot; name=&quot;avatar&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    @if($user-&gt;avatar)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;br&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;img class=&quot;thumbnail img-responsive&quot; src=&quot;{{ $user-&gt;avatar }}&quot; width=&quot;200&quot; /&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    @endif</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [8].png" type="image/png" data-filename="Image.png" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">\<span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">在 Laravel 中，我们可直接通过 请求对象（Request） 来获取用户上传的文件，如以下两种方法：</span></span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 第一种方法</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$file = $request-&gt;file('avatar');</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">// 第二种方法，可读性更高</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$file = $request-&gt;avatar;</span></div></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">app/Http/Controllers/UsersController.php</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function update(UserRequest $request, User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        dd($request-&gt;avatar);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;update($request-&gt;all());</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;route('users.show', $user-&gt;id)-&gt;with('success', '个人资料更新成功！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">测试一下：</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">1. 访问 资料编辑页面 ；</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">2. 点击 『choose file』 按钮，选择图片；</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">3. 点击『保存』按钮提交表单：</span></div><div><br/></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">为null</span></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">经过一番仔细检查后，发现是因为我们忘记为表单添加 enctype=&quot;multipart/form-data&quot; 声明了。请记住，在图片或者文件上传时，为表单添加此句声明是必须的。那我们再次修改下：</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;form action=&quot;{{ route('users.update', $user-&gt;id) }}&quot; method=&quot;POST&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    accept-charset=&quot;UTF-8&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    enctype=&quot;multipart/form-data&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">重新测试一下：</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">1. 访问 资料编辑页面 ；</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">2. 点击 『choose file』 按钮，选择图片；</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">3. 点击『保存』按钮提交表单：</span></div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [9].png" type="image/png" data-filename="Image.png" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">Laravel 的『用户上传文件对象』底层使用了 Symfony 框架的 UploadedFile 对象进行渲染，为我们提供了便捷的文件读取和管理接口，我们将在后面使用这些方法。</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">现在我们已经能得到用户上传的图片数据了，接下来是对图片进行存储。</span></div><div><br/></div><div><span style="font-size: 9pt;"><span style="color: rgb(51, 51, 51); font-family: Monaco; font-size: 9pt; font-weight: bold;">存储用户上传图片</span></span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div>我们可以将『图片上传』核心操作做成一个工具类：</div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">app/Handlers/ImageUploadHandler.php</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Handlers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class ImageUploadHandler</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    // 只允许以下后缀名的图片文件上传</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected $allowed_ext = [&quot;png&quot;, &quot;jpg&quot;, &quot;gif&quot;, 'jpeg'];</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function save($file, $folder, $file_prefix)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 构建存储的文件夹规则，值如：uploads/images/avatars/201709/21/</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 文件夹切割能让查找效率更高。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $folder_name = &quot;uploads/images/$folder/&quot; . date(&quot;Ym/d&quot;, time());</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 文件具体存储的物理路径，`public_path()` 获取的是 `public` 文件夹的物理路径。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 值如：/home/vagrant/Code/larabbs/public/uploads/images/avatars/201709/21/</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $upload_path = public_path() . '/' . $folder_name;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 获取文件的后缀名，因图片从剪贴板里黏贴时后缀名为空，所以此处确保后缀一直存在</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $extension = strtolower($file-&gt;getClientOriginalExtension()) ?: 'png';</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 拼接文件名，加前缀是为了增加辨析度，前缀可以是相关数据模型的 ID</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 值如：1_1493521050_7BVc9v9ujP.png</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $filename = $file_prefix . '_' . time() . '_' . str_random(10) . '.' . $extension;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 如果上传的不是图片将终止操作</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if ( ! in_array($extension, $this-&gt;allowed_ext)) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            return false;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 将图片移动到我们的目标存储路径中</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $file-&gt;move($upload_path, $filename);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'path' =&gt; config('app.url') . &quot;/$folder_name/$filename&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">我们将使用 app/Handlers 文件夹来存放本项目的工具类，『工具类（utility class）』是指一些跟业务逻辑相关性不强的类，Handlers 意为 处理器 ，ImageUploadHandler 意为图片上传处理器，简单易懂。</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">接下来我们需要在 UsersController 里调用：</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Handlers\ImageUploadHandler;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function update(UserRequest $request, ImageUploadHandler $uploader, User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $data = $request-&gt;all();</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if ($request-&gt;avatar) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $result = $uploader-&gt;save($request-&gt;avatar, 'avatars', $user-&gt;id);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if ($result) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                $data['avatar'] = $result['path'];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;update($data);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;route('users.show', $user-&gt;id)-&gt;with('success', '个人资料更新成功！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>1. 因为我们使用了命名空间，所以需要在顶部加载 use App\Handlers\ImageUploadHandler;；</div><div>2. $data = $request-&gt;all(); 赋值 $data 变量，以便对更新数据的操作；</div><div>3. 以下代码处理了图片上传的逻辑，注意 if ($result) 的判断是因为 ImageUploadHandler对文件后缀名做了限定，不允许的情况下将返回 false：</div><div>4. $user-&gt;update($data); 这一步才是执行更新。</div><div><br/></div><div>接下来让我们来测试一下：</div><div>1. 访问 资料编辑页面 ；</div><div>2. 点击 『choose file』 按钮，选择图片；</div><div>3. 点击『保存』按钮提交表单。</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">显示头像</span></div><div><br/></div><div>目前我们有两个地方用到用户头像，第一个是个人空间，第二个是顶部导航栏。</div><div>修改个人空间，将头像的 src 属性修改为 {{ $user-&gt;avatar }}：</div><div>resources/views/users/show.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;div align=&quot;center&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;img class=&quot;thumbnail img-responsive&quot; src=&quot;{{ $user-&gt;avatar }}&quot; width=&quot;300px&quot; height=&quot;300px&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div>接下来修改顶部导航：</div><div>resources/views/layouts/_header.blade.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;!-- navbar --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;nav class=&quot;navbar navbar-default navbar-fixed-top&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;div class=&quot;container&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;navbar-header&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;!-- Collapsed Hamburger --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;button type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#app-navbar-collapse&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;span class=&quot;sr-only&quot;&gt;Toggle Navigation&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/button&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">             &lt;!-- Branding Image --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;a class=&quot;navbar-brand&quot; href=&quot;#&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                青理报修系统</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;app-navbar-collapse&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;!-- Left Side Of Navbar --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;{{ url('/') }}&quot;&gt;首页&lt;/a&gt;&lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li class=&quot;&quot;&gt;&lt;a href=&quot;#&quot;&gt;论坛&lt;/a&gt;&lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li class=&quot;&quot;&gt;&lt;a href=&quot;#&quot;&gt;指南&lt;/a&gt;&lt;/li&gt;                       </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li class=&quot;&quot;&gt;&lt;a href=&quot;#&quot;&gt;地图&lt;/a&gt;&lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li class=&quot;&quot;&gt;&lt;a href=&quot;#&quot;&gt;列表&lt;/a&gt;&lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li class=&quot;&quot;&gt;&lt;a href=&quot;#&quot;&gt;商城&lt;/a&gt;&lt;/li&gt;                        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/ul&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;!-- Right Side Of Navbar --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;!-- &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/ul&gt; --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;!-- Authentication Links --&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                @guest</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;li&gt;&lt;a href=&quot;{{ route('login') }}&quot;&gt;登录&lt;/a&gt;&lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;li&gt;&lt;a href=&quot;{{ route('register') }}&quot;&gt;注册&lt;/a&gt;&lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                @else</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;!--                  &lt;li class=&quot;dropdown&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;a href=&quot;#&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot; role=&quot;button&quot; aria-expanded=&quot;false&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;span class=&quot;user-avatar pull-left&quot; style=&quot;margin-right:8px; margin-top:-5px;&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;img src=&quot;</span><a href="https://fsdhubcdn.phphub.org/uploads/images/201709/20/1/PtDKbASVcz.png?imageView2/1/w/60/h/60" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">https://fsdhubcdn.phphub.org/uploads/images/201709/20/1/PtDKbASVcz.png?imageView2/1/w/60/h/60</a><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&quot; class=&quot;img-responsive img-circle&quot; width=&quot;30px&quot; height=&quot;30px&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            {{ Auth::user()-&gt;name }} &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/a&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;a href=&quot;{{ route('logout') }}&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    onclick=&quot;event.preventDefault();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                             document.getElementById('logout-form').submit();&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    退出登录</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/a&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;form id=&quot;logout-form&quot; action=&quot;{{ route('logout') }}&quot; method=&quot;POST&quot; style=&quot;display: none;&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    {{ csrf_field() }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/form&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/ul&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">--&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;li class=&quot;dropdown&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;a href=&quot;#&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;span class=&quot;glyphicon glyphicon-plus&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/a&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;a href=&quot;&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;span class=&quot;glyphicon glyphicon-wrench&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                发布报修</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/li&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;a href=&quot;#&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;span class=&quot;glyphicon glyphicon-book&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                发表文章</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/li&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/ul&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;a href=&quot;#&quot; class=&quot;notifications-badge&quot; &gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;span class=&quot;badge badge-hint &quot; title=&quot;消息提醒&quot;&gt;           0                           </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;li class=&quot;dropdown&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;a href=&quot;#&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot; role=&quot;button&quot; aria-expanded=&quot;false&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;span class=&quot;user-avatar pull-left&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;img src=&quot;{{ Auth::user()-&gt;avatar }}&quot; class=&quot;img-responsive img-circle&quot; title=&quot;{{ Auth::user()-&gt;name }}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;span class=&quot;caret&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/a&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot;&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;a href=&quot;#&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;span class=&quot;glyphicon glyphicon-dashboard&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                管理后台</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/li&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;a href=&quot;#&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;span class=&quot;glyphicon glyphicon-user&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                个人中心</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/li&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;a href=&quot;{{ route('users.edit', Auth::id()) }}&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;span class=&quot;glyphicon glyphicon-edit&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                编辑资料</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/a&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/li&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;a href=&quot;{{ route('logout') }}&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    onclick=&quot;event.preventDefault();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                             document.getElementById('logout-form').submit();&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    &lt;span class=&quot;glyphicon glyphicon-log-out&quot; aria-hidden=&quot;true&quot;&gt;&lt;/span&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                    退出登录</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                &lt;/a&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;form id=&quot;logout-form&quot; action=&quot;{{ route('logout') }}&quot; method=&quot;POST&quot; style=&quot;display: none;&quot;&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                                {{ csrf_field() }}</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                            &lt;/form&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                        &lt;/li&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    &lt;/ul&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                &lt;/li&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                @endguest</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            &lt;/ul&gt;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    &lt;/div&gt;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;/nav&gt;</span></div></div><div><br/></div><div><img src="2.3 -- 个人页面_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">图片验证</span></div><div><br/></div><div>当用户上传分辨率太小的图片时，会影响网站的美观，所以我们需要对图片的分辨率大小加以限制。得益于 Laravel 强大的表单验证功能，我们只需要在 UserRequest 中增加图片验证规则即可：</div><div><br/></div><div>app/Http/Requests/UserRequest.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Requests;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Foundation\Http\FormRequest;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Auth;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UserRequest extends FormRequest</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function authorize()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return true;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function rules()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name' =&gt; 'required|between:3,25|regex:/^[A-Za-z0-9\-\_]+$/|unique:users,name,' . Auth::id(),</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'email' =&gt; 'required|email',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'introduction' =&gt; 'max:80',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'avatar' =&gt; 'mimes:jpeg,bmp,png,gif|dimensions:min_width=200,min_height=200',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function messages()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'avatar.mimes' =&gt;'头像必须是 jpeg, bmp, png, gif 格式的图片',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'avatar.dimensions' =&gt; '图片的清晰度不够，宽和高需要 200px 以上',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name.unique' =&gt; '用户名已被占用，请重新填写',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name.regex' =&gt; '用户名只支持英文、数字、横杆和下划线。',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name.between' =&gt; '用户名必须介于 3 - 25 个字符之间。',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'name.required' =&gt; '用户名不能为空。',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>1. rules() 方法中新增了图片比例验证规则 dimensions ，仅允许上传宽和高都大于 200px 的图片；</div><div>2. messages() 方法中新增了头像出错时的提示信息。</div><div><br/></div><div>宽和高等于 200px 是怎么得到呢？调出 Chrome 开发者工具 进行源代码查看，鼠标放置于图片链接时，即可看到图片尺寸：</div><div><br/></div><div>200px 保证了页面区 181px 的显示区域下能清晰的显示图片。</div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">裁剪图片</span></div><div><br/></div><div>我们还有一个地方要优化，用户有时会上传分辨率较大的图片</div><div><br/></div><div>而我们个人空间里显示区域最大也就 181px，即使要兼容 视网膜屏幕（Retina Screen） 的话，最多也就需要 181px * 2 = 362px 。图片太大会拖慢页面的加载速度，所以接下来我们将对此进行优化。</div><div>我们将使用有名的 Intervention/image 扩展包来处理图片裁切的逻辑，接下来我们需要先安装此扩展包；</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">安装扩展包</span></div><div><br/></div><div>1. Composer 安装</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ composer require intervention/image</span></div></div><div><br/></div><div>2. 配置信息</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ php artisan vendor:publish --provider=&quot;Intervention\Image\ImageServiceProviderLaravel5&quot;</span></div></div><div><br/></div><div>打开 config/image.php 文件可以看到只有一个驱动器的选项，支持的值有 GD 库 和 ImageMagic：</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">开始裁剪</span></div><div><br/></div><div>我们将裁切的逻辑写在 ImageUploadHandler 中，请将以下代码替换：</div><div>app/Handlers/ImageUploadHandler.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Handlers;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Image;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class ImageUploadHandler</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected $allowed_ext = [&quot;png&quot;, &quot;jpg&quot;, &quot;gif&quot;, 'jpeg'];</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function save($file, $folder, $file_prefix, $max_width = false)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 构建存储的文件夹规则，值如：uploads/images/avatars/201709/21/</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 文件夹切割能让查找效率更高。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $folder_name = &quot;uploads/images/$folder/&quot; . date(&quot;Ym/d&quot;, time());</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 文件具体存储的物理路径，`public_path()` 获取的是 `public` 文件夹的物理路径。</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 值如：/home/vagrant/Code/larabbs/public/uploads/images/avatars/201709/21/</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $upload_path = public_path() . '/' . $folder_name;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 获取文件的后缀名，因图片从剪贴板里黏贴时后缀名为空，所以此处确保后缀一直存在</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $extension = strtolower($file-&gt;getClientOriginalExtension()) ?: 'png';</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 拼接文件名，加前缀是为了增加辨析度，前缀可以是相关数据模型的 ID</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 值如：1_1493521050_7BVc9v9ujP.png</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $filename = $file_prefix . '_' . time() . '_' . str_random(10) . '.' . $extension;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 如果上传的不是图片将终止操作</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if ( ! in_array($extension, $this-&gt;allowed_ext)) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            return false;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 将图片移动到我们的目标存储路径中</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $file-&gt;move($upload_path, $filename);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 如果限制了图片宽度，就进行裁剪</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if ($max_width &amp;&amp; $extension != 'gif') {</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            // 此类中封装的函数，用于裁剪图片</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $this-&gt;reduceSize($upload_path . '/' . $filename, $max_width);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            'path' =&gt; config('app.url') . &quot;/$folder_name/$filename&quot;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function reduceSize($file_path, $max_width)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 先实例化，传参是文件的磁盘物理路径</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $image = Image::make($file_path);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 进行大小调整的操作</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $image-&gt;resize($max_width, null, function ($constraint) {</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            // 设定宽度是 $max_width，高度等比例双方缩放</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $constraint-&gt;aspectRatio();</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            // 防止裁图时图片尺寸变大</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $constraint-&gt;upsize();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 对图片修改后进行保存</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $image-&gt;save();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>以上的 save() 方法中，我们新增了 $max_width 参数，用来指定最大图片宽度，我们修改 UsersController 的 update() 方法中的调用，修改为：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$result = $uploader-&gt;save($request-&gt;avatar, 'avatars', $user-&gt;id, 362);</span></div></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">样式调整</span></div><div><br/></div><div>以下区域有点留白过多：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">resources/assets/sass/app.scss</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">/* User profile page */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.users-show-page {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .user-info {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        .thumbnail {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            margin-bottom: 0px;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">Git 版本控制</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git add -A</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git commit -m &quot;User can upload avatar&quot;</span></div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">权限控制</span></div><div><span style="font-weight: bold;"><br/></span></div><div><span style="font-weight: bold;"><br/></span></div><div>现在的应用存在两个巨大的安全隐患：</div><div><br/></div><div>1. 未登录用户可以访问 edit 和 update 动作，如果你退出登录，以游客身份访问 http://larabbs.test/users/1/edit ：</div><div>2. 登录用户可以更新其它用户的个人信息，如果我们再次注册一个用户：</div><div><br/></div><div>登录状态的 2 号用户 Aufree 居然可以访问 1 号用户 Summer 的个人编辑页面，甚至是修改内容。</div><div>接下来让我们针对这两个安全隐患进行修复。</div><div><br/></div><div><br/></div><div><br/></div><div><b>限制游客访问</b></div><div><br/></div><div>Laravel 中间件 (Middleware) 为我们提供了一种非常棒的过滤机制来过滤进入应用的 HTTP 请求，例如，当我们使用 Auth 中间件来验证用户的身份时，如果用户未通过身份验证，则 Auth 中间件会把用户重定向到登录页面。如果用户通过了身份验证，则 Auth 中间件会通过此请求并接着往下执行。Laravel 框架默认为我们内置了一些中间件，例如身份验证、CSRF 保护等。所有的中间件文件都被放在项目的 app/Http/Middleware 文件夹中。</div><div>接下来让我们使用 Laravel 提供身份验证（Auth）中间件来过滤未登录用户的 edit, update 动作：</div><div><br/></div><div>app/Http/Controllers/UsersController.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function __construct()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;middleware('auth', ['except' =&gt; ['show']]);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div><b>用户只能编辑自己的资料</b></div><div><br/></div><div>在完成对未登录用户的限制之后，接下来我们要限制的是已登录用户的操作。当 id 为 2 的用户去尝试更新 id 为 1 的用户信息时，我们应该返回一个 403 禁止访问的异常。在 Laravel 中可以使用 授权策略 (Policy) 来对用户的操作权限进行验证，在用户未经授权进行操作时将返回 403 禁止访问的异常。</div><div>我们可以使用以下命令来生成一个名为 UserPolicy 的授权策略类文件，用于管理用户模型的授权。</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ php artisan make:policy UserPolicy</span></div></div><div><br/></div><div>所有生成的授权策略文件都会被放置在 app/Policies 文件夹下。</div><div>让我们为默认生成的用户授权策略添加 update 方法，用于用户更新时的权限验证。</div><div><br/></div><div>app/Policies/UserPolicy.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Policies;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use App\Models\User;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">use Illuminate\Auth\Access\HandlesAuthorization;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UserPolicy</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    use HandlesAuthorization;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function update(User $currentUser, User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return $currentUser-&gt;id === $user-&gt;id;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>update 方法接收两个参数，第一个参数默认为当前登录用户实例，第二个参数则为要进行授权的用户实例。当两个 id 相同时，则代表两个用户是相同用户，用户通过授权，可以接着进行下一个操作。如果 id 不相同的话，将抛出 403 异常信息来拒绝访问。</div><div>使用授权策略需要注意以下两点：</div><div><br/></div><div>1. 我们并不需要检查 $currentUser 是不是 NULL。未登录用户，框架会自动为其 所有权限 返回 false；</div><div>2. 调用时，默认情况下，我们 不需要 传递当前登录用户至该方法内，因为框架会自动加载当前登录用户（接着看下去，后面有例子）；</div><div><br/></div><div><br/></div><div>接下来我们还需要在 AuthServiceProvider 类中对授权策略进行注册。AuthServiceProvider 包含了一个 policies 属性，该属性用于将各种模型对应到管理它们的授权策略上。我们需要为用户模型 User 指定授权策略 UserPolicy。</div><div><br/></div><div>app/Providers/AuthServiceProvider.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Providers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class AuthServiceProvider extends ServiceProvider</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * The policy mappings for the application.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @var array</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected $policies = [</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        'App\Model' =&gt; 'App\Policies\ModelPolicy',</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        \App\Models\User::class  =&gt; \App\Policies\UserPolicy::class,</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    ];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div><div>授权策略定义完成之后，我们便可以在控制器中使用 authorize 方法来检验用户是否授权。默认的 App\Http\Controllers\Controller 控制器基类包含了 Laravel 的 AuthorizesRequests trait。此 trait 提供了 authorize 方法，它可以被用于快速授权一个指定的行为，当无权限运行该行为时会抛出 HttpException。authorize 方法接收两个参数，第一个为授权策略的名称，第二个为进行授权验证的数据。</div><div><br/></div><div>我们需要为 edit 和 update 方法加上这行：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$this-&gt;authorize('update', $user);</span></div></div><div><br/></div><div>app/Http/Controllers/UsersController.php</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">namespace App\Http\Controllers;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function edit(User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;authorize('update', $user);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return view('users.edit', compact('user'));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public function update(UserRequest $request, ImageUploadHandler $uploader, User $user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $this-&gt;authorize('update', $user);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $data = $request-&gt;all();</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if ($request-&gt;avatar) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $result = $uploader-&gt;save($request-&gt;avatar, 'avatars', $user-&gt;id, 362);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if ($result) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                $data['avatar'] = $result['path'];</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $user-&gt;update($data);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return redirect()-&gt;route('users.show', $user-&gt;id)-&gt;with('success', '个人资料更新成功！');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>此时可以访问别的用户的编辑页面, 但是无法提交修改, 也就是无权限</div><div><br/></div><div><b>Git 版本控制</b></div><div><b><br/></b></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git add -A</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">$ git commit -m &quot;Only authorized user can edit user profile&quot;</span></div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 