<html>
<head>
  <title>8.4--在生产环境中发送邮件</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600363 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1478"/>
<h1>8.4--在生产环境中发送邮件</h1>

<div>
<span><div><div>邮件通知</div><div><br/></div><div>本章节我们将 话题有新回复 通知新增 邮件通知频道, 当话题被回复时, 作者可以收到一份 email 邮件通知, laravel 的通知系统默认支持邮件频道的通知方式, 我们只要稍作配置即可</div><div><br/></div><div>laravel 支持多种邮件驱动, 包括 smtp. Mailgun,mail和sendmail, Mailgun, Amazon SES, Maildrill</div><div> 都是第三方邮件服务, mail驱动使用 php 提供的 mail 函数, sendmail 驱动通过 Sendmai/Postfix (Linux) 提供的命令发送邮件, smtp 驱动支持 ESMTP 的 SMTP 服务器发送邮件, mail 不安全, sendmail 需要配置 Sendmail/Postfix, 并且信用不高, 很容易被当成垃圾邮件, 第三方服务的信用是最高的, 商业软件推荐使用.</div><div><br/></div><div>本章节以 QQ邮件为例, 我们将开启 QQ 的 SMTP 功能, 并配置项目的 SMTP 邮件发送功能, 其他邮件的配置大体相同.</div><div><br/></div><div>1.开启 QQ 邮箱的 SMTP 支持</div><div><br/></div><div>首先我们需要早 QQ 邮箱的账号设置里面开启 POP3 和 SMTP 服务</div><div><br/></div><div><img src="8.4--在生产环境中发送邮件_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><img src="8.4--在生产环境中发送邮件_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>授权码将作为我们的密码进行使用</div><div><br/></div><div>2.邮件发送配置</div><div><br/></div><div>laravel 中邮箱发送的配置存放于 config/mail.php 中, 不过 mail.php 中我们所需的配置, 都可以通过 .env 来配置, 作为最佳实践, 我们优先选择通过环境变量来配置</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.env</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_DRIVER=smtp</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_HOST=</span><a href="http://smtp.qq.com/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">smtp.qq.com</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_PORT=25</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_USERNAME=</span><a href="mailto:xxxxxxxxxxxxxx@qq.com" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">xxxxxxxxxxxxxx@qq.com</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_PASSWORD=xxxxxxxxx</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_ENCRYPTION=tls</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_FROM_ADDRESS=</span><a href="mailto:xxxxxxxxxxxxxx@qq.com" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">xxxxxxxxxxxxxx@qq.com</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">MAIL_FROM_NAME=SampleApp</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div></div><div><br/></div><div>选项讲解</div><ol><li><div>使用支持 ESMTP 的 SMTP 服务器发送邮件</div></li><li><div>QQ 邮箱的 SMTP 服务器地址, 必须为此至此值</div></li><li><div>QQ 邮箱的 SMTP 服务器端口, 必须为此值</div></li><li><div>username 不解释</div></li><li><div>密码就是我们的授权码</div></li><li><div>tls 是我们的加密类型, 其它选项还有 ssl</div></li><li><div>传送地址, 和 用户名一致, 不解释</div></li><li><div>用来作为邮件的发送者名称</div></li></ol><div><br/></div><div><br/></div><div>历史遗留问题</div><div><br/></div><div>还记得账户激活章节的邮件激活逻辑吗?现在我们已经在配置环境中完善了邮件的发送配置, 因此不再需要使用 from 方法</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">app/Http/Controllers/UsersController.php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">&lt;?php</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">.</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">class UsersController extends Controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">{</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    .</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected function sendEmailConfirmationTo($user)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $view = 'emails.confirm';</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $data = compact('user');</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $to = $user-&gt;email;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        $subject = &quot;感谢注册 Sample 应用！请确认你的邮箱。&quot;;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        Mail::send($view, $data, function ($message) use ($to, $subject) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            $message-&gt;to($to)-&gt;subject($subject);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        });</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div>一切完成后我们进行代码提交, 本行内容大致结束</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ git add -A</div><div>$ git commit -m &quot;Add password resets $ email configuration&quot;</div><div>$ git checkout master</div><div>$ git merge account-activation-password-resets</div><div>$ git push</div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 